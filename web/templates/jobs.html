{% extends "base.html" %}

{% block title %}Job Database - DataRoles Admin{% endblock %}

{% block content %}
<div x-data="jobsPage()">
    <!-- Page Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Job Database</h1>
                <p class="text-gray-600 mt-1">
                    <span x-text="stats.total_jobs"></span> total jobs • 
                    <span x-text="stats.active_jobs"></span> active • 
                    <span x-text="stats.inactive_jobs"></span> inactive
                </p>
            </div>
            <div class="flex items-center space-x-3">
                <!-- AI Stats -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg px-4 py-2">
                    <div class="text-sm text-blue-900">
                        <span class="font-semibold">AI Enriched:</span>
                        <span x-text="aiStats.enriched"></span> / <span x-text="aiStats.total"></span>
                        (<span x-text="aiStats.percentage_enriched"></span>%)
                    </div>
                </div>
                <!-- Enrich Selected Button -->
                <button @click="enrichSelected" 
                        :disabled="enriching || selectedJobs.length === 0"
                        x-show="selectedJobs.length > 0"
                        class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="zap" class="w-4 h-4 mr-2"></i>
                    <span x-show="!enriching">Enrich Selected (<span x-text="selectedJobs.length"></span>)</span>
                    <span x-show="enriching">Enriching...</span>
                </button>
                <!-- Enrich All Button -->
                <button @click="enrichAllUnenriched" 
                        :disabled="enriching || aiStats.unenriched === 0"
                        class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i>
                    <span x-show="!enriching">Enrich All (<span x-text="aiStats.unenriched"></span>)</span>
                    <span x-show="enriching">Enriching...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Search & Filter Bar -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex items-center space-x-4 mb-4">
            <div class="flex-1">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-3 w-5 h-5 text-gray-400"></i>
                    <input type="text" x-model="searchQuery" @input="debounceSearch"
                           placeholder="Search jobs, companies, keywords..."
                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button @click="viewMode = 'table'" 
                        :class="viewMode === 'table' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'"
                        class="p-2 rounded-lg hover:bg-blue-50">
                    <i data-lucide="list" class="w-5 h-5"></i>
                </button>
                <button @click="viewMode = 'card'" 
                        :class="viewMode === 'card' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'"
                        class="p-2 rounded-lg hover:bg-blue-50">
                    <i data-lucide="grid" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="flex flex-wrap gap-2">
            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">
                    <i data-lucide="building" class="w-4 h-4 mr-1"></i>
                    Company
                    <i data-lucide="chevron-down" class="w-4 h-4 ml-1"></i>
                </button>
                <div x-show="open" @click.away="open = false" x-cloak
                     class="absolute z-10 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 p-3">
                    <input type="text" x-model="filters.companySearch" @input="searchCompanies"
                           placeholder="Search companies..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-2">
                    <div class="max-h-48 overflow-y-auto">
                        <template x-for="company in companyOptions" :key="company.id">
                            <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" :value="company.id" x-model="filters.companies" @change="currentPage = 1; loadJobs()" class="mr-2">
                                <span class="text-sm" x-text="company.name"></span>
                            </label>
                        </template>
                    </div>
                </div>
            </div>

            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">
                    <i data-lucide="map-pin" class="w-4 h-4 mr-1"></i>
                    Location
                    <i data-lucide="chevron-down" class="w-4 h-4 ml-1"></i>
                </button>
                <div x-show="open" @click.away="open = false" x-cloak
                     class="absolute z-10 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 p-3">
                    <input type="text" x-model="filters.locationSearch" @input="searchLocations"
                           placeholder="Search locations..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-2">
                    <div class="max-h-48 overflow-y-auto">
                        <template x-for="location in locationOptions" :key="location.id">
                            <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" :value="location.id" x-model="filters.locations" @change="currentPage = 1; loadJobs()" class="mr-2">
                                <span class="text-sm" x-text="location.full_location_string"></span>
                            </label>
                        </template>
                    </div>
                </div>
            </div>

            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">
                    <i data-lucide="briefcase" class="w-4 h-4 mr-1"></i>
                    Seniority
                    <i data-lucide="chevron-down" class="w-4 h-4 ml-1"></i>
                </button>
                <div x-show="open" @click.away="open = false" x-cloak
                     class="absolute z-10 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 p-3">
                    <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" value="Entry level" x-model="filters.seniority" @change="currentPage = 1; loadJobs()" class="mr-2">
                        <span class="text-sm">Entry Level</span>
                    </label>
                    <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" value="Mid-Senior level" x-model="filters.seniority" @change="currentPage = 1; loadJobs()" class="mr-2">
                        <span class="text-sm">Mid-Senior</span>
                    </label>
                    <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" value="Director" x-model="filters.seniority" @change="currentPage = 1; loadJobs()" class="mr-2">
                        <span class="text-sm">Director</span>
                    </label>
                    <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" value="Executive" x-model="filters.seniority" @change="currentPage = 1; loadJobs()" class="mr-2">
                        <span class="text-sm">Executive</span>
                    </label>
                </div>
            </div>

            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">
                    <i data-lucide="clock" class="w-4 h-4 mr-1"></i>
                    Employment
                    <i data-lucide="chevron-down" class="w-4 h-4 ml-1"></i>
                </button>
                <div x-show="open" @click.away="open = false" x-cloak
                     class="absolute z-10 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 p-3">
                    <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" value="Full-time" x-model="filters.employment" @change="currentPage = 1; loadJobs()" class="mr-2">
                        <span class="text-sm">Full-time</span>
                    </label>
                    <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" value="Part-time" x-model="filters.employment" @change="currentPage = 1; loadJobs()" class="mr-2">
                        <span class="text-sm">Part-time</span>
                    </label>
                    <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" value="Contract" x-model="filters.employment" @change="currentPage = 1; loadJobs()" class="mr-2">
                        <span class="text-sm">Contract</span>
                    </label>
                </div>
            </div>

            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">
                    <i data-lucide="tag" class="w-4 h-4 mr-1"></i>
                    Types
                    <i data-lucide="chevron-down" class="w-4 h-4 ml-1"></i>
                </button>
                <div x-show="open" @click.away="open = false" x-cloak
                     class="absolute z-10 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 p-3">
                    <input type="text" x-model="filters.typesSearch" @input="searchTypes"
                           placeholder="Search types..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-2">
                    <div class="max-h-48 overflow-y-auto">
                        <template x-for="type in typesOptions" :key="type.id">
                            <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="checkbox" :value="type.id" x-model="filters.types" @change="currentPage = 1; loadJobs()" class="mr-2">
                                <span class="text-sm" x-text="type.name"></span>
                            </label>
                        </template>
                    </div>
                </div>
            </div>

            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">
                    <i data-lucide="calendar" class="w-4 h-4 mr-1"></i>
                    Posted Date
                    <i data-lucide="chevron-down" class="w-4 h-4 ml-1"></i>
                </button>
                <div x-show="open" @click.away="open = false" x-cloak
                     class="absolute z-10 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 p-3">
                    <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="radio" value="today" x-model="filters.postedDate" @change="currentPage = 1; loadJobs()" class="mr-2">
                        <span class="text-sm">Today</span>
                    </label>
                    <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="radio" value="week" x-model="filters.postedDate" @change="currentPage = 1; loadJobs()" class="mr-2">
                        <span class="text-sm">Last 7 days</span>
                    </label>
                    <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="radio" value="month" x-model="filters.postedDate" @change="currentPage = 1; loadJobs()" class="mr-2">
                        <span class="text-sm">Last 30 days</span>
                    </label>
                    <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="radio" value="all" x-model="filters.postedDate" @change="currentPage = 1; loadJobs()" class="mr-2">
                        <span class="text-sm">All time</span>
                    </label>
                </div>
            </div>

            <div class="relative" x-data="{ open: false }">
                <button @click="open = !open" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">
                    <i data-lucide="sparkles" class="w-4 h-4 mr-1"></i>
                    AI Status
                    <i data-lucide="chevron-down" class="w-4 h-4 ml-1"></i>
                </button>
                <div x-show="open" @click.away="open = false" x-cloak
                     class="absolute z-10 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 p-3">
                    <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="radio" value="all" x-model="filters.aiStatus" @change="currentPage = 1; loadJobs()" class="mr-2">
                        <span class="text-sm">All</span>
                    </label>
                    <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="radio" value="enriched" x-model="filters.aiStatus" @change="currentPage = 1; loadJobs()" class="mr-2">
                        <span class="text-sm">Enriched</span>
                    </label>
                    <label class="flex items-center px-2 py-1.5 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="radio" value="not_enriched" x-model="filters.aiStatus" @change="currentPage = 1; loadJobs()" class="mr-2">
                        <span class="text-sm">Not Enriched</span>
                    </label>
                </div>
            </div>

            <label class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 cursor-pointer">
                <input type="checkbox" x-model="filters.activeOnly" @change="currentPage = 1; loadJobs()" class="mr-2">
                <span>Active Only</span>
            </label>

            <button @click="clearFilters" x-show="hasActiveFilters" 
                    class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                Clear All
            </button>
        </div>

        <!-- Active Filters Display -->
        <div x-show="hasActiveFilters" class="mt-3 flex flex-wrap gap-2">
            <span class="text-sm text-gray-600">Active filters:</span>
            <template x-for="filter in activeFiltersList" :key="filter.type + filter.id">
                <span class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-700 rounded text-sm">
                    <span x-text="filter.label"></span>
                    <button @click="removeFilter(filter)" class="ml-1 hover:bg-blue-200 rounded">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </span>
            </template>
        </div>
    </div>

    <!-- Bulk Actions Bar -->
    <div x-show="selectedJobs.length > 0" x-cloak 
         class="mb-4 bg-blue-50 border border-blue-200 rounded-lg px-4 py-3 flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <span class="text-sm font-medium text-blue-900">
                <span x-text="selectedJobs.length"></span> selected
            </span>
            <button @click="archiveSelected" class="text-sm text-blue-700 hover:text-blue-800 font-medium">Archive</button>
            <button @click="exportSelected" class="text-sm text-blue-700 hover:text-blue-800 font-medium">Export CSV</button>
            <button @click="deleteSelected" class="text-sm text-red-700 hover:text-red-800 font-medium">Delete</button>
        </div>
        <button @click="selectedJobs = []" class="text-blue-700 hover:text-blue-800">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>

    <!-- Table View -->
    <div x-show="viewMode === 'table'" class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left">
                        <input type="checkbox" @change="toggleAll" class="rounded border-gray-300">
                    </th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" @click="sortBy('title')">
                        Job Title
                        <i data-lucide="chevron-up" class="w-4 h-4 inline" x-show="sortField === 'title' && sortDirection === 'asc'"></i>
                        <i data-lucide="chevron-down" class="w-4 h-4 inline" x-show="sortField === 'title' && sortDirection === 'desc'"></i>
                    </th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Types</th>
                    <th class="px-8 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" @click="sortBy('posted_date')">
                        Posted
                    </th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">AI</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <template x-if="jobs.length === 0">
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center">
                            <div class="text-gray-400">
                                <i data-lucide="briefcase" class="w-12 h-12 mx-auto mb-3"></i>
                                <p class="text-lg font-medium">No jobs found</p>
                                <p class="text-sm mt-1">Try adjusting your filters</p>
                            </div>
                        </td>
                    </tr>
                </template>
                
                <template x-for="job in jobs" :key="job.id">
                    <tr class="hover:bg-gray-50 cursor-pointer" @click="viewJob(job.id)">
                        <td class="px-4 py-1.5" @click.stop>
                            <input type="checkbox" :value="job.id" x-model="selectedJobs" class="rounded border-gray-300">
                        </td>
                        <td class="px-4 py-1.5">
                            <div class="text-sm font-medium text-gray-900 truncate max-w-md" x-text="job.title"></div>
                        </td>
                        <td class="px-4 py-1.5 text-sm text-gray-900" x-text="job.companies?.name || '-'"></td>
                        <td class="px-4 py-1.5 text-sm text-gray-600" x-text="job.locations?.city || '-'"></td>
                        <td class="px-4 py-1.5">
                            <div class="flex flex-wrap gap-1">
                                <template x-if="job.job_types && job.job_types.length > 0">
                                    <template x-for="type in job.job_types" :key="type.id">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium text-white"
                                              :style="`background-color: ${type.color}`"
                                              x-text="type.name"></span>
                                    </template>
                                </template>
                                <template x-if="!job.job_types || job.job_types.length === 0">
                                    <span class="text-xs text-gray-400">-</span>
                                </template>
                            </div>
                        </td>
                        <td class="px-8 py-1.5 text-sm text-gray-600 whitespace-nowrap" x-text="formatExactDate(job.posted_date)"></td>
                        <td class="px-4 py-1.5">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                  :class="job.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'">
                                <span x-text="job.is_active ? 'Active' : 'Inactive'"></span>
                            </span>
                        </td>
                        <td class="px-4 py-1.5" @click.stop>
                            <div class="flex items-center gap-2">
                                <button @click="enrichJob(job.id, job.ai_enriched)" 
                                        class="inline-flex items-center justify-center w-7 h-7 hover:bg-blue-50 rounded group"
                                        :title="job.ai_enriched ? 'Re-enrich with AI' : 'Enrich with AI'">
                                    <i data-lucide="sparkles" 
                                       :class="job.ai_enriched ? 'w-4 h-4 text-blue-600' : 'w-3.5 h-3.5 text-gray-400 group-hover:text-blue-600'"></i>
                                </button>
                                <span x-show="job.ai_enriched && job.ai_data?.type_datarol" 
                                      class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"
                                      x-text="job.ai_data?.type_datarol"></span>
                            </div>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>

        <!-- Pagination -->
        <div class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
            <div class="text-sm text-gray-700">
                Showing <span x-text="(currentPage - 1) * pageSize + 1"></span> to 
                <span x-text="Math.min(currentPage * pageSize, stats.total_jobs)"></span> of 
                <span x-text="stats.total_jobs"></span> jobs
            </div>
            <div class="flex space-x-2">
                <button @click="previousPage" :disabled="currentPage === 1"
                        class="px-3 py-1 border border-gray-300 rounded-lg text-sm hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                    Previous
                </button>
                <template x-for="page in visiblePages" :key="page">
                    <button @click="currentPage = page; loadJobs()" 
                            :class="currentPage === page ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'"
                            class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                        <span x-text="page"></span>
                    </button>
                </template>
                <button @click="nextPage" :disabled="currentPage === totalPages"
                        class="px-3 py-1 border border-gray-300 rounded-lg text-sm hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
                    Next
                </button>
            </div>
        </div>
    </div>

    <!-- Card View -->
    <div x-show="viewMode === 'card'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <template x-for="job in jobs" :key="job.id">
            <div class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition-shadow cursor-pointer" @click="viewJob(job.id)">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-200 rounded flex items-center justify-center text-gray-600 font-semibold">
                            <span x-text="(job.companies?.name || 'C')[0]"></span>
                        </div>
                        <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900" x-text="job.companies?.name || 'Unknown'"></div>
                        </div>
                    </div>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                          :class="job.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'">
                        <span x-text="job.is_active ? 'Active' : 'Inactive'"></span>
                    </span>
                </div>
                
                <h3 class="text-lg font-semibold text-gray-900 mb-2" x-text="job.title"></h3>
                
                <div class="space-y-2 text-sm text-gray-600 mb-4">
                    <div class="flex items-center">
                        <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>
                        <span x-text="job.locations?.full_location_string || '-'"></span>
                    </div>
                    <div class="flex items-center">
                        <i data-lucide="briefcase" class="w-4 h-4 mr-2"></i>
                        <span x-text="job.employment_type || '-'"></span>
                        <span x-show="job.seniority_level" class="mx-1">•</span>
                        <span x-text="job.seniority_level"></span>
                    </div>
                    <div class="flex items-center" x-show="job.salary_min || job.salary_max">
                        <i data-lucide="dollar-sign" class="w-4 h-4 mr-2"></i>
                        <span x-text="formatSalary(job)"></span>
                    </div>
                </div>
                
                <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                    <div class="text-xs text-gray-500">
                        Posted <span x-text="formatDate(job.posted_date)"></span>
                    </div>
                    <div class="text-xs text-gray-500" x-show="job.applicant_count">
                        <span x-text="job.applicant_count"></span> applicants
                    </div>
                </div>
            </div>
        </template>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function jobsPage() {
    return {
        jobs: [],
        selectedJobs: [],
        viewMode: 'table',
        searchQuery: '',
        searchTimeout: null,
        currentPage: 1,
        pageSize: 50,
        sortField: 'posted_date',
        sortDirection: 'desc',
        stats: {
            total_jobs: 0,
            active_jobs: 0,
            inactive_jobs: 0
        },
        aiStats: {
            total: 0,
            enriched: 0,
            unenriched: 0,
            percentage_enriched: 0
        },
        enriching: false,
        totalCount: 0,
        filters: {
            companies: [],
            locations: [],
            seniority: [],
            employment: [],
            types: [],
            postedDate: 'all',
            aiStatus: 'all',
            activeOnly: true,
            companySearch: '',
            locationSearch: '',
            typesSearch: ''
        },
        companyOptions: [],
        locationOptions: [],
        typesOptions: [],
        jobsCache: {},
        cacheTimestamp: {},
        cacheDuration: 10 * 60 * 1000, // 10 minutes
        
        async init() {
            // Load cache from localStorage
            this.loadCacheFromStorage();
            
            // Check for company_id in URL params
            const urlParams = new URLSearchParams(window.location.search);
            const companyId = urlParams.get('company_id');
            if (companyId) {
                this.filters.companies = [companyId];
            }
            
            // Load types for filter
            await this.searchTypes();
            
            await this.loadJobs();
            await this.loadAIStats();
            
            // Prefetch first 3 pages
            this.prefetchPages();
            
            this.$nextTick(() => lucide.createIcons());
        },
        
        loadCacheFromStorage() {
            try {
                const cachedData = localStorage.getItem('jobsCache');
                const cachedTimestamps = localStorage.getItem('jobsCacheTimestamp');
                
                if (cachedData && cachedTimestamps) {
                    this.jobsCache = JSON.parse(cachedData);
                    this.cacheTimestamp = JSON.parse(cachedTimestamps);
                    
                    // Clean up expired cache entries
                    const now = Date.now();
                    Object.keys(this.cacheTimestamp).forEach(key => {
                        if (now - this.cacheTimestamp[key] > this.cacheDuration) {
                            delete this.jobsCache[key];
                            delete this.cacheTimestamp[key];
                        }
                    });
                    
                    console.log('Loaded cache from localStorage:', Object.keys(this.jobsCache).length, 'pages');
                }
            } catch (error) {
                console.error('Failed to load cache from storage:', error);
            }
        },
        
        saveCacheToStorage() {
            try {
                localStorage.setItem('jobsCache', JSON.stringify(this.jobsCache));
                localStorage.setItem('jobsCacheTimestamp', JSON.stringify(this.cacheTimestamp));
            } catch (error) {
                console.error('Failed to save cache to storage:', error);
            }
        },
        
        async prefetchPages() {
            // Prefetch pages 2 and 3 in background
            for (let page = 2; page <= 3; page++) {
                setTimeout(() => {
                    this.fetchAndCachePage(page);
                }, (page - 1) * 500); // Stagger requests
            }
        },
        
        async fetchAndCachePage(page) {
            const cacheKey = this.getCacheKey(page);
            
            try {
                const params = new URLSearchParams({
                    limit: this.pageSize,
                    offset: (page - 1) * this.pageSize,
                    search: this.searchQuery,
                    is_active: this.filters.activeOnly
                });
                
                // Add filter parameters
                if (this.filters.companies.length > 0) {
                    params.append('company_ids', this.filters.companies.join(','));
                }
                if (this.filters.locations.length > 0) {
                    params.append('location_ids', this.filters.locations.join(','));
                }
                if (this.filters.seniority.length > 0) {
                    this.filters.seniority.forEach(s => params.append('seniority', s));
                }
                if (this.filters.employment.length > 0) {
                    this.filters.employment.forEach(e => params.append('employment', e));
                }
                if (this.filters.types.length > 0) {
                    params.append('type_ids', this.filters.types.join(','));
                }
                if (this.filters.postedDate && this.filters.postedDate !== 'all') {
                    params.append('posted_date', this.filters.postedDate);
                }
                if (this.filters.aiStatus && this.filters.aiStatus !== 'all') {
                    params.append('ai_enriched', this.filters.aiStatus === 'enriched' ? 'true' : 'false');
                }
                
                const response = await fetch(`/api/jobs/?${params}`);
                const data = await response.json();
                
                // Cache the data
                this.jobsCache[cacheKey] = data;
                this.cacheTimestamp[cacheKey] = Date.now();
                this.saveCacheToStorage();
                
                console.log(`Cached page ${page}`);
            } catch (error) {
                console.error(`Failed to prefetch page ${page}:`, error);
            }
        },
        
        getCacheKey(page) {
            return `${page}_${this.searchQuery}_${this.filters.companies.join(',')}_${this.filters.locations.join(',')}_${this.filters.seniority.join(',')}_${this.filters.employment.join(',')}_${this.filters.types.join(',')}_${this.filters.postedDate}_${this.filters.aiStatus}_${this.filters.activeOnly}`;
        },
        
        isCacheValid(cacheKey) {
            if (!this.jobsCache[cacheKey]) return false;
            const age = Date.now() - (this.cacheTimestamp[cacheKey] || 0);
            return age < this.cacheDuration;
        },
        
        invalidateCache() {
            this.jobsCache = {};
            this.cacheTimestamp = {};
            // Also clear from localStorage
            localStorage.removeItem('jobsCache');
            localStorage.removeItem('jobsCacheTimestamp');
            console.log('Cache invalidated');
        },
        
        async loadAIStats() {
            try {
                const response = await fetch('/api/jobs/enrich/stats');
                const data = await response.json();
                this.aiStats = data;
            } catch (error) {
                console.error('Failed to load AI stats:', error);
            }
        },
        
        async enrichJob(jobId, isAlreadyEnriched = false) {
            // Confirm if re-enriching
            if (isAlreadyEnriched) {
                if (!confirm('This job is already enriched. Re-enrich with AI?')) {
                    return;
                }
            }
            
            try {
                const url = `/api/jobs/${jobId}/enrich${isAlreadyEnriched ? '?force=true' : ''}`;
                const response = await fetch(url, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Enrichment failed');
                }
                
                alert(isAlreadyEnriched ? 'Job re-enriched successfully!' : 'Job enriched successfully!');
                await this.loadJobs();
                await this.loadAIStats();
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to enrich job:', error);
                alert('Failed to enrich job: ' + error.message);
            }
        },
        
        async enrichSelected() {
            if (this.selectedJobs.length === 0) {
                alert('No jobs selected');
                return;
            }
            
            if (!confirm(`Enrich ${this.selectedJobs.length} selected job(s)? This may take a few minutes.`)) {
                return;
            }
            
            this.enriching = true;
            
            try {
                // Enrich selected jobs in batch
                const enrichResponse = await fetch('/api/jobs/enrich/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.selectedJobs)
                });
                
                const result = await enrichResponse.json();
                
                alert(`Enrichment complete!\nSuccessful: ${result.stats.successful}\nFailed: ${result.stats.failed}`);
                
                // Clear selection
                this.selectedJobs = [];
                
                // Reload data
                await this.loadJobs();
                await this.loadAIStats();
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to enrich selected jobs:', error);
                alert('Failed to enrich jobs: ' + error.message);
            } finally {
                this.enriching = false;
            }
        },
        
        async enrichAllUnenriched() {
            if (!confirm(`Enrich all ${this.aiStats.unenriched} unenriched jobs? This may take several minutes.`)) {
                return;
            }
            
            this.enriching = true;
            
            try {
                // Get unenriched job IDs
                const response = await fetch('/api/jobs/enrich/unenriched?limit=1000');
                const data = await response.json();
                
                if (data.job_ids.length === 0) {
                    alert('No unenriched jobs found');
                    return;
                }
                
                // Enrich in batch
                const enrichResponse = await fetch('/api/jobs/enrich/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data.job_ids)
                });
                
                const result = await enrichResponse.json();
                
                alert(`Enrichment complete!\nSuccessful: ${result.stats.successful}\nFailed: ${result.stats.failed}`);
                
                await this.loadJobs();
                await this.loadAIStats();
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to enrich jobs:', error);
                alert('Failed to enrich jobs: ' + error.message);
            } finally {
                this.enriching = false;
            }
        },
        
        async loadJobs() {
            try {
                const cacheKey = this.getCacheKey(this.currentPage);
                
                // Check if we have valid cached data
                if (this.isCacheValid(cacheKey)) {
                    console.log(`Loading page ${this.currentPage} from cache`);
                    const data = this.jobsCache[cacheKey];
                    this.jobs = data.jobs;
                    this.stats = data.stats;
                    this.totalCount = data.total || data.stats.total_jobs;
                    this.$nextTick(() => lucide.createIcons());
                    return;
                }
                
                // Fetch from API
                console.log(`Fetching page ${this.currentPage} from API`);
                const params = new URLSearchParams({
                    limit: this.pageSize,
                    offset: (this.currentPage - 1) * this.pageSize,
                    search: this.searchQuery,
                    is_active: this.filters.activeOnly
                });
                
                // Add filter parameters
                if (this.filters.companies.length > 0) {
                    params.append('company_ids', this.filters.companies.join(','));
                }
                if (this.filters.locations.length > 0) {
                    params.append('location_ids', this.filters.locations.join(','));
                }
                if (this.filters.seniority.length > 0) {
                    this.filters.seniority.forEach(s => params.append('seniority', s));
                }
                if (this.filters.employment.length > 0) {
                    this.filters.employment.forEach(e => params.append('employment', e));
                }
                if (this.filters.types.length > 0) {
                    params.append('type_ids', this.filters.types.join(','));
                }
                if (this.filters.postedDate && this.filters.postedDate !== 'all') {
                    params.append('posted_date', this.filters.postedDate);
                }
                if (this.filters.aiStatus && this.filters.aiStatus !== 'all') {
                    params.append('ai_enriched', this.filters.aiStatus === 'enriched' ? 'true' : 'false');
                }
                
                const response = await fetch(`/api/jobs/?${params}`);
                const data = await response.json();
                
                // Cache the data
                this.jobsCache[cacheKey] = data;
                this.cacheTimestamp[cacheKey] = Date.now();
                this.saveCacheToStorage();
                
                this.jobs = data.jobs;
                this.stats = data.stats;
                this.totalCount = data.total || data.stats.total_jobs;
                
                // Prefetch next page if we're on page 1 or 2
                if (this.currentPage <= 2) {
                    setTimeout(() => {
                        this.fetchAndCachePage(this.currentPage + 1);
                    }, 500);
                }
                
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to load jobs:', error);
            }
        },
        
        debounceSearch() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.currentPage = 1;
                this.invalidateCache(); // Clear cache when search changes
                this.loadJobs();
            }, 300);
        },
        
        async searchCompanies() {
            if (this.filters.companySearch.length < 2) return;
            try {
                const response = await fetch(`/api/jobs/companies/autocomplete?q=${this.filters.companySearch}`);
                const data = await response.json();
                this.companyOptions = data.companies;
            } catch (error) {
                console.error('Failed to search companies:', error);
            }
        },
        
        async searchLocations() {
            if (this.filters.locationSearch.length < 2) return;
            try {
                const response = await fetch(`/api/jobs/locations/autocomplete?q=${this.filters.locationSearch}`);
                const data = await response.json();
                this.locationOptions = data.locations;
            } catch (error) {
                console.error('Failed to search locations:', error);
            }
        },
        
        async searchCompanies() {
            if (this.filters.companySearch.length < 2) return;
            try {
                const response = await fetch(`/api/jobs/companies/autocomplete?q=${this.filters.companySearch}`);
                const data = await response.json();
                this.companyOptions = data.companies;
            } catch (error) {
                console.error('Failed to search companies:', error);
            }
        },
        
        async searchLocations() {
            if (this.filters.locationSearch.length < 2) return;
            try {
                const response = await fetch(`/api/jobs/locations/autocomplete?q=${this.filters.locationSearch}`);
                const data = await response.json();
                this.locationOptions = data.locations;
            } catch (error) {
                console.error('Failed to search locations:', error);
            }
        },
        
        async searchTypes() {
            try {
                const response = await fetch(`/api/jobs/types`);
                const data = await response.json();
                this.typesOptions = data.types || [];
                
                // Filter by search term if provided
                if (this.filters.typesSearch) {
                    this.typesOptions = this.typesOptions.filter(type => 
                        type.name.toLowerCase().includes(this.filters.typesSearch.toLowerCase())
                    );
                }
            } catch (error) {
                console.error('Failed to search types:', error);
            }
        },
        
        sortBy(field) {
            if (this.sortField === field) {
                this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortField = field;
                this.sortDirection = 'asc';
            }
            this.loadJobs();
        },
        
        get hasActiveFilters() {
            return this.filters.companies.length > 0 || 
                   this.filters.locations.length > 0 || 
                   this.filters.seniority.length > 0 || 
                   this.filters.employment.length > 0;
        },
        
        get activeFiltersList() {
            const filters = [];
            
            // Add company names
            this.filters.companies.forEach(companyId => {
                const company = this.companyOptions.find(c => c.id === companyId);
                if (company) {
                    filters.push({ type: 'company', id: companyId, label: company.name });
                }
            });
            
            // Add location names
            this.filters.locations.forEach(locationId => {
                const location = this.locationOptions.find(l => l.id === locationId);
                if (location) {
                    filters.push({ type: 'location', id: locationId, label: location.full_location_string });
                }
            });
            
            // Add seniority levels
            this.filters.seniority.forEach(s => {
                filters.push({ type: 'seniority', id: s, label: s });
            });
            
            // Add employment types
            this.filters.employment.forEach(e => {
                filters.push({ type: 'employment', id: e, label: e });
            });
            
            return filters;
        },
        
        clearFilters() {
            this.filters = {
                companies: [],
                locations: [],
                seniority: [],
                employment: [],
                activeOnly: true,
                companySearch: '',
                locationSearch: ''
            };
            this.currentPage = 1;
            this.loadJobs();
        },
        
        removeFilter(filter) {
            // Remove specific filter based on type
            if (filter.type === 'company') {
                this.filters.companies = this.filters.companies.filter(id => id !== filter.id);
            } else if (filter.type === 'location') {
                this.filters.locations = this.filters.locations.filter(id => id !== filter.id);
            } else if (filter.type === 'seniority') {
                this.filters.seniority = this.filters.seniority.filter(s => s !== filter.id);
            } else if (filter.type === 'employment') {
                this.filters.employment = this.filters.employment.filter(e => e !== filter.id);
            }
            this.currentPage = 1;
            this.loadJobs();
        },
        
        toggleAll(event) {
            if (event.target.checked) {
                this.selectedJobs = this.jobs.map(j => j.id);
            } else {
                this.selectedJobs = [];
            }
        },
        
        async archiveSelected() {
            if (!confirm(`Archive ${this.selectedJobs.length} jobs?`)) return;
            try {
                await fetch('/api/jobs/bulk/archive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.selectedJobs)
                });
                await this.loadJobs();
                this.selectedJobs = [];
            } catch (error) {
                console.error('Failed to archive jobs:', error);
            }
        },
        
        exportSelected() {
            // TODO: Implement CSV export
            alert('Export feature coming soon!');
        },
        
        async deleteSelected() {
            if (!confirm(`Permanently delete ${this.selectedJobs.length} jobs?`)) return;
            try {
                await fetch('/api/jobs/bulk/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.selectedJobs)
                });
                await this.loadJobs();
                this.selectedJobs = [];
            } catch (error) {
                console.error('Failed to delete jobs:', error);
            }
        },
        
        viewJob(jobId) {
            window.location.href = `/jobs/${jobId}`;
        },
        
        get totalPages() {
            return Math.ceil(this.totalCount / this.pageSize);
        },
        
        get visiblePages() {
            const pages = [];
            const start = Math.max(1, this.currentPage - 2);
            const end = Math.min(this.totalPages, this.currentPage + 2);
            for (let i = start; i <= end; i++) {
                pages.push(i);
            }
            return pages;
        },
        
        previousPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                this.loadJobs();
            }
        },
        
        nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                this.loadJobs();
            }
        },
        
        formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / 86400000);
            
            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;
            if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
            return `${Math.floor(days / 30)} months ago`;
        },
        
        formatExactDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }
    }
}
</script>
{% endblock %}
