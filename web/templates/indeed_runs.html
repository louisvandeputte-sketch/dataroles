{% extends "base.html" %}

{% block title %}Indeed Scrape Runs - everyjob{% endblock %}

{% block content %}
<div x-data="runsPage()">
    <!-- Page Header with Tabs -->
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-4">Indeed Scrape Runs</h1>
        
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8">
                <button @click="activeTab = 'all'" 
                        :class="activeTab === 'all' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    All Runs
                </button>
                <button @click="activeTab = 'archived'" 
                        :class="activeTab === 'archived' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Archived
                </button>
            </nav>
        </div>
    </div>

    <!-- Active Runs Section (shown at top of All Runs tab) -->
    <div x-show="activeTab === 'all' && activeRuns.length > 0" class="space-y-4 mb-6">
        <template x-if="activeRuns.length === 0">
            <div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">
                <i data-lucide="zap" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i>
                <p class="text-lg font-medium">No active scrapes</p>
                <p class="text-sm mt-1">Start a scrape from the Search Queries page</p>
            </div>
        </template>
        
        <template x-for="run in activeRuns" :key="run.id">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                            <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                            RUNNING
                        </span>
                    </div>
                    <button @click="stopScrape(run.id)" 
                            class="px-3 py-1 border border-red-300 text-red-700 rounded-lg hover:bg-red-50 text-sm font-medium"
                            :disabled="run.stopping">
                        <span x-show="!run.stopping">Stop Scrape</span>
                        <span x-show="run.stopping">Stopping...</span>
                    </button>
                </div>
                
                <h3 class="text-lg font-semibold text-gray-900 mb-1">
                    "<span x-text="run.search_query"></span>" in <span x-text="run.location_query"></span>
                </h3>
                <p class="text-sm text-gray-600 mb-4">
                    Started <span x-text="formatDate(run.created_at || run.completed_at)"></span>
                </p>
                
                <!-- Progress Bar (only for truly running scrapes) -->
                <div class="mb-4" x-show="run.status === 'running'">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>Progress</span>
                        <span>Running...</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full animate-pulse" style="width: 100%"></div>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="grid grid-cols-4 gap-4 mb-4">
                    <div>
                        <div class="text-2xl font-bold text-gray-900" x-text="run.jobs_found || 0"></div>
                        <div class="text-xs text-gray-600">Jobs Found</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-green-600" x-text="run.jobs_new || 0"></div>
                        <div class="text-xs text-gray-600">New</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-blue-600" x-text="run.jobs_updated || 0"></div>
                        <div class="text-xs text-gray-600">Updated</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold" :class="(run.metadata?.jobs_error || 0) > 0 ? 'text-red-600' : 'text-gray-600'" x-text="run.metadata?.jobs_error || 0"></div>
                        <div class="text-xs text-gray-600">Failed</div>
                    </div>
                </div>
                
                <div class="flex items-center justify-between pt-4 border-t border-gray-200">
                    <div class="text-sm text-gray-600">
                        API Calls: 12/100 per hour • Rate limit: <span class="text-green-600 font-medium">OK</span>
                    </div>
                    <div class="space-x-2">
                        <button class="text-sm text-blue-600 hover:text-blue-700 font-medium">View Live Log</button>
                        <button class="text-sm text-blue-600 hover:text-blue-700 font-medium">View Details</button>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- History Table -->
    <div x-show="activeTab === 'all' || activeTab === 'archived'" class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Query</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trigger</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Started</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Results</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-16"></th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <template x-if="filteredRuns.length === 0">
                    <tr>
                        <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                            No runs found
                        </td>
                    </tr>
                </template>
                
                <template x-for="run in filteredRuns" :key="run.id">
                    <tr class="hover:bg-gray-50 cursor-pointer" @click="viewRunDetail(run.id)">
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                  :class="{
                                      'bg-green-100 text-green-800': run.status === 'completed',
                                      'bg-red-100 text-red-800': run.status === 'failed',
                                      'bg-yellow-100 text-yellow-800': run.status === 'partial',
                                      'bg-blue-100 text-blue-800': run.status === 'running'
                                  }">
                                <span x-text="run.status"></span>
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span x-show="run.job_type" class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium text-white"
                                  :style="`background-color: ${run.job_type?.color || '#6B7280'}`"
                                  x-text="run.job_type?.name || '-'"></span>
                            <span x-show="!run.job_type" class="text-xs text-gray-400">-</span>
                        </td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900" x-text="run.search_query"></td>
                        <td class="px-6 py-4 text-sm text-gray-600" x-text="run.location_query"></td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium"
                                  :class="{
                                      'bg-purple-100 text-purple-800': run.trigger_type === 'scheduled',
                                      'bg-gray-100 text-gray-800': run.trigger_type === 'manual',
                                      'bg-blue-100 text-blue-800': run.trigger_type === 'api'
                                  }">
                                <i :data-lucide="run.trigger_type === 'scheduled' ? 'clock' : (run.trigger_type === 'api' ? 'code' : 'play')" class="w-3 h-3 mr-1"></i>
                                <span x-text="run.trigger_type || 'manual'"></span>
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600" x-text="formatDate(run.created_at)"></td>
                        <td class="px-6 py-4 text-sm text-gray-600">
                            <span x-text="run.metadata?.duration_seconds ? run.metadata.duration_seconds.toFixed(1) + 's' : '-'"></span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            <span x-text="`${run.jobs_new || 0} new / ${run.jobs_updated || 0} updated`"></span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <button @click.stop="toggleArchive(run.id, run.archived)" 
                                    class="text-gray-400 hover:text-gray-600 transition-colors"
                                    :title="run.archived ? 'Unarchive' : 'Archive'">
                                <i :data-lucide="run.archived ? 'archive-restore' : 'archive'" class="w-5 h-5"></i>
                            </button>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>
    
    <!-- Run Details Modal -->
    <div x-show="showDetailModal" 
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         @keydown.escape.window="showDetailModal = false">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div x-show="showDetailModal"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75"
                 @click="showDetailModal = false"></div>

            <!-- Modal panel -->
            <div x-show="showDetailModal"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                
                <template x-if="selectedRun">
                    <div>
                        <!-- Header -->
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900">Scrape Run Details</h3>
                                <button @click="showDetailModal = false" class="text-gray-400 hover:text-gray-600">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="px-6 py-4 max-h-[75vh] overflow-y-auto">
                            <!-- Compact Summary -->
                            <div class="mb-4 flex items-center justify-between">
                                <div>
                                    <div class="text-sm text-gray-600">
                                        "<span class="font-medium text-gray-900" x-text="selectedRun.search_query"></span>" in 
                                        <span class="font-medium text-gray-900" x-text="selectedRun.location_query"></span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        <span x-text="formatDate(selectedRun.started_at)"></span> • 
                                        <span x-show="selectedRun.metadata?.duration_seconds" x-text="selectedRun.metadata?.duration_seconds?.toFixed(0) + 's'"></span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                          :class="{
                                              'bg-green-100 text-green-800': selectedRun.status === 'completed',
                                              'bg-red-100 text-red-800': selectedRun.status === 'failed',
                                              'bg-yellow-100 text-yellow-800': selectedRun.status === 'partial',
                                              'bg-blue-100 text-blue-800': selectedRun.status === 'running'
                                          }">
                                        <span x-text="selectedRun.status"></span>
                                    </span>
                                    <span class="text-sm text-gray-600">
                                        <span class="font-semibold" x-text="selectedRun.jobs_found || 0"></span> jobs
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Error Details (if any) -->
                            <div x-show="selectedRun.jobs_error && selectedRun.jobs_error > 0" class="mb-4 bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-start">
                                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-600 mr-2 mt-0.5"></i>
                                    <div class="flex-1">
                                        <h4 class="text-sm font-medium text-red-800 mb-2">
                                            <span x-text="selectedRun.jobs_error"></span> job(s) failed to process
                                        </h4>
                                        <div x-show="selectedRun.error_details && selectedRun.error_details.length > 0" class="space-y-1">
                                            <template x-for="(error, index) in selectedRun.error_details" :key="index">
                                                <div class="text-xs text-red-700 font-mono bg-red-100 rounded px-2 py-1">
                                                    <span x-text="error.error"></span>
                                                </div>
                                            </template>
                                        </div>
                                        <p x-show="!selectedRun.error_details || selectedRun.error_details.length === 0" class="text-xs text-red-700">
                                            Jobs failed during processing (validation or database errors)
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Jobs Table -->
                            <div class="mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-sm font-medium text-gray-700">Jobs from this run</h4>
                                    <span class="text-xs text-gray-500" x-show="runJobs.length > 0">
                                        Showing <span x-text="runJobs.length"></span> of <span x-text="selectedRun.jobs_found || 0"></span>
                                    </span>
                                </div>
                                
                                <div x-show="loadingJobs" class="text-center py-8 text-gray-500">
                                    <i data-lucide="loader" class="w-6 h-6 mx-auto animate-spin mb-2"></i>
                                    <p class="text-sm">Loading jobs...</p>
                                </div>
                                
                                <div x-show="!loadingJobs && runJobs.length === 0" class="text-center py-8 text-gray-500">
                                    <i data-lucide="inbox" class="w-8 h-8 mx-auto mb-2"></i>
                                    <p class="text-sm">No jobs found for this run</p>
                                    <p x-show="selectedRun.jobs_error && selectedRun.jobs_error > 0" class="text-xs text-red-600 mt-2">
                                        All jobs failed to process - see error details above
                                    </p>
                                </div>
                                
                                <div x-show="!loadingJobs && runJobs.length > 0" class="border rounded-lg overflow-hidden">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Job Title</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Company</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Posted</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <template x-for="job in runJobs" :key="job.id">
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-4 py-3">
                                                        <div class="text-sm font-medium text-gray-900" x-text="job.title"></div>
                                                        <div class="text-xs text-gray-500" x-show="job.seniority_level" x-text="job.seniority_level"></div>
                                                    </td>
                                                    <td class="px-4 py-3 text-sm text-gray-700" x-text="job.companies?.name || 'Unknown'"></td>
                                                    <td class="px-4 py-3 text-sm text-gray-700" x-text="job.locations?.city || 'Unknown'"></td>
                                                    <td class="px-4 py-3 text-xs text-gray-500" x-text="formatDate(job.posted_date)"></td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Run ID -->
                            <div class="mb-4">
                                <h4 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-2">Run ID</h4>
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <code class="text-xs text-gray-700" x-text="selectedRun.id"></code>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                            <button @click="showDetailModal = false" 
                                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
                                Close
                            </button>
                            <a :href="`/jobs?run_id=${selectedRun.id}`"
                               class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
                                View Jobs
                            </a>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function runsPage() {
    return {
        activeTab: 'all',  // Start with all runs
        runs: [],
        activeRuns: [],
        showDetailModal: false,
        selectedRun: null,
        runJobs: [],  // Jobs from selected run
        loadingJobs: false,  // Loading state for jobs
        
        async init() {
            await this.loadRuns();
            await this.loadActiveRuns();
            
            // Poll for updates every 5 seconds
            setInterval(() => {
                this.loadActiveRuns();
            }, 5000);
            
            this.$nextTick(() => lucide.createIcons());
        },
        
        async loadRuns() {
            try {
                // Add timestamp to prevent caching
                const response = await fetch(`/api/indeed/runs/?t=${Date.now()}`);
                const data = await response.json();
                this.runs = data.runs;
                console.log('Runs loaded:', this.runs.length, 'runs');
                console.log('Archived runs:', this.runs.filter(r => r.archived).length);
                
                // Refresh icons after data load
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to load runs:', error);
            }
        },
        
        async loadActiveRuns() {
            try {
                // Add timestamp to prevent caching
                const response = await fetch(`/api/indeed/runs/active?t=${Date.now()}`);
                const data = await response.json();
                this.activeRuns = data.runs;
                console.log('Active runs loaded:', this.activeRuns.length, 'runs');
            } catch (error) {
                console.error('Failed to load active runs:', error);
            }
        },
        
        get filteredRuns() {
            const filtered = this.activeTab === 'all' 
                ? this.runs.filter(r => !r.archived)
                : this.activeTab === 'archived'
                ? this.runs.filter(r => r.archived)
                : this.runs;
            
            console.log(`Filtered runs (${this.activeTab}):`, filtered.length);
            return filtered;
        },
        
        async toggleArchive(runId, currentlyArchived) {
            try {
                const response = await fetch(`/api/indeed/runs/${runId}/archive`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ archived: !currentlyArchived })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to toggle archive');
                }
                
                // Reload runs and refresh icons
                await this.loadRuns();
                this.$nextTick(() => lucide.createIcons());
                console.log('Run archive status toggled');
            } catch (error) {
                console.error('Failed to toggle archive:', error);
                alert('Failed to update archive status: ' + error.message);
            }
        },
        
        formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        },
        
        async viewRunDetail(runId) {
            console.log('Loading run details:', runId);
            
            try {
                // Fetch full run details from API
                const response = await fetch(`/api/indeed/runs/${runId}`);
                const data = await response.json();
                
                this.selectedRun = data;
                this.showDetailModal = true;
                this.runJobs = [];
                this.loadingJobs = true;
                
                // Re-initialize Lucide icons after modal opens
                this.$nextTick(() => lucide.createIcons());
                
                // Load jobs from this run
                this.loadRunJobs(runId);
            } catch (error) {
                console.error('Failed to load run details:', error);
                alert('Failed to load run details');
            }
        },
        
        async loadRunJobs(runId) {
            try {
                // Fetch jobs from this specific run
                const response = await fetch(`/api/jobs/?run_id=${runId}&limit=50`);
                const data = await response.json();
                
                this.runJobs = data.jobs || [];
                this.loadingJobs = false;
                
                console.log('Loaded', this.runJobs.length, 'jobs for run');
                
                // Re-initialize icons for the table
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to load run jobs:', error);
                this.loadingJobs = false;
            }
        },
        
        async stopScrape(runId) {
            console.log('Stopping scrape:', runId);
            
            if (!confirm('Stop this scrape immediately?\n\nThis will mark the run as failed and stop tracking it.')) {
                return;
            }
            
            // Find the run and set stopping flag
            const run = this.activeRuns.find(r => r.id === runId);
            if (run) {
                run.stopping = true;
            }
            
            try {
                const response = await fetch(`/api/indeed/runs/${runId}/stop`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to stop scrape');
                }
                
                const data = await response.json();
                
                // Reload active runs to update UI
                await this.loadActiveRuns();
                await this.loadRuns();
                
                alert('Scrape stopped successfully!');
                console.log('Scrape stopped successfully');
            } catch (error) {
                console.error('Failed to stop scrape:', error);
                alert('Failed to stop scrape: ' + error.message);
                
                // Reset stopping flag on error
                if (run) {
                    run.stopping = false;
                }
            }
        }
    }
}
</script>
{% endblock %}
