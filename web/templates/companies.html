{% extends "base.html" %}

{% block title %}Companies - everyjob{% endblock %}

{% block content %}
<div x-data="companiesPage()">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Companies</h1>
                <p class="text-gray-600 mt-1">Manage company master data</p>
            </div>
            <div class="flex items-center space-x-3">
                <!-- AI Enrichment Stats -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg px-4 py-2">
                    <div class="text-sm text-purple-900">
                        <span class="font-semibold">AI Enriched:</span>
                        <span x-text="aiStats.enriched"></span> / <span x-text="aiStats.total"></span>
                        (<span x-text="aiStats.percentage_enriched"></span>%)
                    </div>
                </div>
                <!-- Enrich Selected Button -->
                <button @click="enrichSelected" 
                        :disabled="enriching || selectedCompanies.length === 0"
                        x-show="selectedCompanies.length > 0"
                        class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                    <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i>
                    <span x-show="!enriching">Enrich Selected (<span x-text="selectedCompanies.length"></span>)</span>
                    <span x-show="enriching">Enriching...</span>
                </button>
                <!-- Enrich All Button -->
                <button @click="enrichAllUnenriched()" 
                        :disabled="enriching || aiStats.unenriched === 0"
                        class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                    <i data-lucide="zap" class="w-4 h-4 mr-2"></i>
                    <span x-show="!enriching">Enrich All (<span x-text="aiStats.unenriched"></span>)</span>
                    <span x-show="enriching">Enriching...</span>
                </button>
                <!-- Classify All Enriched Button -->
                <button @click="classifyAllEnriched()" 
                        :disabled="classifyingConsulting || aiStats.enriched === 0"
                        class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                    <i data-lucide="briefcase" class="w-4 h-4 mr-2"></i>
                    <span x-show="!classifyingConsulting">Classify Consulting (<span x-text="aiStats.enriched"></span>)</span>
                    <span x-show="classifyingConsulting">Classifying...</span>
                </button>
                <button @click="clearCache()" 
                        class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
                    <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                    Reload Data
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Companies</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="total"></p>
                    </div>
                    <i data-lucide="building-2" class="w-8 h-8 text-blue-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">With Master Data</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="withMasterData"></p>
                    </div>
                    <i data-lucide="database" class="w-8 h-8 text-green-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Verified</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="verified"></p>
                    </div>
                    <i data-lucide="check-circle" class="w-8 h-8 text-purple-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Size Classified</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="sizeStats.classified || 0"></p>
                        <p class="text-xs text-gray-500" x-text="'(' + (sizeStats.pending || 0) + ' pending)'"></p>
                    </div>
                    <i data-lucide="building" class="w-8 h-8 text-orange-500"></i>
                </div>
            </div>
        </div>

        <!-- Search -->
        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <input type="text" x-model="search" @input="loadCompanies()" 
                   placeholder="Search companies..."
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
    </div>

    <!-- Companies Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div x-show="loading" class="text-center py-12">
            <i data-lucide="loader" class="w-8 h-8 mx-auto animate-spin text-blue-500 mb-3"></i>
            <p class="text-gray-500">Loading companies...</p>
        </div>

        <div x-show="!loading && companies.length === 0" class="text-center py-12">
            <i data-lucide="building-2" class="w-12 h-12 mx-auto text-gray-300 mb-3"></i>
            <p class="text-gray-500">No companies found</p>
        </div>

        <div x-show="!loading && companies.length > 0">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left">
                                <input type="checkbox" @change="toggleAll" class="rounded border-gray-300">
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                            <th class="px-2 py-2 text-left text-xs font-semibold text-gray-500">Category</th>
                            <th class="px-2 py-2 text-left text-xs font-semibold text-gray-500">Locatie Belgi√´</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hiring Model</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sector</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Website</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jobs Page</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="company in companies" :key="company.id">
                        <tr class="hover:bg-gray-50 cursor-pointer" @click="viewCompany(company)">
                            <!-- Checkbox -->
                            <td class="px-4 py-3" @click.stop>
                                <input type="checkbox" 
                                       :checked="selectedCompanies.includes(company.id)"
                                       @change="toggleCompanySelection(company.id)"
                                       class="rounded border-gray-300">
                            </td>
                            <!-- Company Name & Logo -->
                            <td class="px-3 py-2">
                                <div class="flex items-center min-w-[180px]">
                                    <img x-show="company.logo_url" :src="company.logo_url" :alt="company.name" 
                                         class="w-7 h-7 rounded object-cover mr-2 flex-shrink-0">
                                    <div x-show="!company.logo_url" class="w-7 h-7 rounded bg-gray-100 flex items-center justify-center mr-2 flex-shrink-0">
                                        <i data-lucide="building-2" class="w-4 h-4 text-gray-400"></i>
                                    </div>
                                    <div class="text-sm font-medium text-gray-900 truncate" x-text="company.name"></div>
                                </div>
                            </td>
                            <!-- Hiring Model (Editable Dropdown) -->
                            <td class="px-2 py-2" @click.stop>
                                <div x-data="{ editing: false, value: company.company_master_data?.hiring_model || '' }">
                                    <!-- Display mode -->
                                    <div x-show="!editing" @click="editing = true" class="cursor-pointer">
                                        <span x-show="value" 
                                              class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium hover:opacity-80"
                                              :class="{
                                                  'bg-green-100 text-green-800': value === 'direct',
                                                  'bg-orange-100 text-orange-800': value === 'recruitment',
                                                  'bg-gray-100 text-gray-800': value === 'unknown'
                                              }"
                                              x-text="value === 'direct' ? 'Direct' : value === 'recruitment' ? 'Recruitment' : 'Unknown'">
                                        </span>
                                        <span x-show="!value" class="text-xs text-gray-400 hover:bg-gray-100 px-1 py-0.5 rounded">-</span>
                                    </div>
                                    <!-- Edit mode (Dropdown) -->
                                    <select x-show="editing"
                                            x-model="value"
                                            @change="editing = false; updateCompanyField(company.id, 'hiring_model', value)"
                                            @blur="editing = false"
                                            @keydown.escape="editing = false; value = company.company_master_data?.hiring_model || ''"
                                            class="text-xs border border-blue-300 rounded px-1 py-0.5 w-full max-w-[120px] focus:outline-none focus:ring-1 focus:ring-blue-500"
                                            x-init="$watch('editing', value => { if(value) $el.focus() })">
                                        <option value="">-</option>
                                        <option value="direct">Direct</option>
                                        <option value="recruitment">Recruitment</option>
                                        <option value="unknown">Unknown</option>
                                    </select>
                                </div>
                            </td>
                            <!-- Sector (Multi-language Editable) -->
                            <td class="px-2 py-2" @click.stop>
                                <div x-data="{ 
                                    editing: false, 
                                    sector_nl: company.company_master_data?.sector_nl || '',
                                    sector_en: company.company_master_data?.sector_en || '',
                                    sector_fr: company.company_master_data?.sector_fr || ''
                                }">
                                    <!-- Display mode -->
                                    <div x-show="!editing" 
                                         @click="editing = true"
                                         class="text-xs text-gray-600 cursor-pointer hover:bg-gray-100 px-1 py-0.5 rounded"
                                         :title="'NL: ' + (sector_nl || '-') + '\nEN: ' + (sector_en || '-') + '\nFR: ' + (sector_fr || '-')">
                                        <div class="truncate max-w-[120px]" x-text="sector_nl || sector_en || sector_fr || '-'"></div>
                                    </div>
                                    <!-- Edit mode (3 inputs) -->
                                    <div x-show="editing" class="space-y-1 min-w-[200px]">
                                        <div class="flex items-center space-x-1">
                                            <span class="text-xs text-gray-500 w-6">NL:</span>
                                            <input x-model="sector_nl"
                                                   @keydown.enter="editing = false; updateCompanyFields(company.id, {sector_nl, sector_en, sector_fr})"
                                                   @keydown.escape="editing = false; sector_nl = company.company_master_data?.sector_nl || ''"
                                                   class="text-xs border border-blue-300 rounded px-1 py-0.5 flex-1 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                   placeholder="Nederlands"
                                                   x-init="$watch('editing', value => { if(value) $el.focus() })">
                                        </div>
                                        <div class="flex items-center space-x-1">
                                            <span class="text-xs text-gray-500 w-6">EN:</span>
                                            <input x-model="sector_en"
                                                   @keydown.enter="editing = false; updateCompanyFields(company.id, {sector_nl, sector_en, sector_fr})"
                                                   @keydown.escape="editing = false; sector_en = company.company_master_data?.sector_en || ''"
                                                   class="text-xs border border-blue-300 rounded px-1 py-0.5 flex-1 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                   placeholder="English">
                                        </div>
                                        <div class="flex items-center space-x-1">
                                            <span class="text-xs text-gray-500 w-6">FR:</span>
                                            <input x-model="sector_fr"
                                                   @keydown.enter="editing = false; updateCompanyFields(company.id, {sector_nl, sector_en, sector_fr})"
                                                   @keydown.escape="editing = false; sector_fr = company.company_master_data?.sector_fr || ''"
                                                   class="text-xs border border-blue-300 rounded px-1 py-0.5 flex-1 focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                   placeholder="Fran√ßais">
                                        </div>
                                        <button @click="editing = false; updateCompanyFields(company.id, {sector_nl, sector_en, sector_fr})"
                                                class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 w-full">
                                            Save
                                        </button>
                                    </div>
                                </div>
                            </td>
                            <!-- Category (Editable Dropdown) -->
                            <td class="px-2 py-2" @click.stop>
                                <div x-data="{ editing: false, value: company.company_master_data?.size_category || '' }">
                                    <template x-if="!editing">
                                        <!-- Display mode - show canonical size_category value -->
                                        <div @click="editing = true"
                                             class="text-xs text-gray-600 truncate max-w-[120px] cursor-pointer hover:bg-gray-100 px-1 py-0.5 rounded"
                                             :title="'Canonical: ' + (company.company_master_data?.size_category || 'none')">
                                            <span x-text="company.company_master_data?.size_category || '-'"></span>
                                        </div>
                                    </template>
                                    <template x-if="editing">
                                        <!-- Edit mode (Dropdown) - edit size_category enum -->
                                        <select x-model="value"
                                                @change="editing = false; updateCompanyField(company.id, 'size_category', value)"
                                                @blur="editing = false"
                                                @keydown.escape="editing = false; value = company.company_master_data?.size_category || ''"
                                                class="text-xs border border-blue-300 rounded px-1 py-0.5 w-full max-w-[120px] focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                x-init="$nextTick(() => $el.focus())">
                                            <option value="">-</option>
                                            <option value="startup">startup</option>
                                            <option value="scaleup">scaleup</option>
                                            <option value="sme">sme</option>
                                            <option value="established_enterprise">established_enterprise</option>
                                            <option value="corporate">corporate</option>
                                            <option value="public_company">public_company</option>
                                            <option value="government">government</option>
                                            <option value="unknown">unknown</option>
                                        </select>
                                    </template>
                                </div>
                            </td>
                            <!-- Locatie Belgi√´ -->
                            <td class="px-2 py-2" @click.stop>
                                <div x-data="{ editing: false, value: company.company_master_data?.locatie_belgie || '' }">
                                    <template x-if="!editing">
                                        <div @click="editing = true"
                                             class="text-xs text-gray-600 truncate max-w-[140px] cursor-pointer hover:bg-gray-100 px-1 py-0.5 rounded"
                                             :title="value || 'Locatie in Belgi√´'">
                                            <span x-text="value || '-'"></span>
                                        </div>
                                    </template>
                                    <template x-if="editing">
                                        <input type="text"
                                               x-model="value"
                                               @keydown.enter="editing = false; updateCompanyField(company.id, 'locatie_belgie', value)"
                                               @blur="editing = false; updateCompanyField(company.id, 'locatie_belgie', value)"
                                               @keydown.escape="editing = false; value = company.company_master_data?.locatie_belgie || ''"
                                               class="text-xs border border-blue-300 rounded px-1 py-0.5 w-full max-w-[140px] focus:outline-none focus:ring-1 focus:ring-blue-500"
                                               placeholder="bv. Brussel"
                                               x-init="$nextTick(() => $el.focus())">
                                    </template>
                                </div>
                            </td>
                            <!-- Bedrijfswebsite -->
                            <td class="px-2 py-2" @click.stop>
                                <a x-show="company.company_master_data?.bedrijfswebsite" 
                                   :href="company.company_master_data?.bedrijfswebsite" 
                                   target="_blank"
                                   class="inline-flex items-center text-blue-600 hover:text-blue-800"
                                   :title="company.company_master_data?.bedrijfswebsite">
                                    <i data-lucide="globe" class="w-4 h-4 mr-1"></i>
                                    <span class="text-xs">Link</span>
                                </a>
                                <span x-show="!company.company_master_data?.bedrijfswebsite" class="text-xs text-gray-400">-</span>
                            </td>
                            <!-- Jobspagina -->
                            <td class="px-2 py-2" @click.stop>
                                <a x-show="company.company_master_data?.jobspagina" 
                                   :href="company.company_master_data?.jobspagina" 
                                   target="_blank"
                                   class="inline-flex items-center text-blue-600 hover:text-blue-800"
                                   :title="company.company_master_data?.jobspagina">
                                    <i data-lucide="briefcase" class="w-4 h-4 mr-1"></i>
                                    <span class="text-xs">Link</span>
                                </a>
                                <span x-show="!company.company_master_data?.jobspagina" class="text-xs text-gray-400">-</span>
                            </td>
                            <!-- Actions -->
                            <td class="px-2 py-2" @click.stop>
                                <div class="flex items-center justify-center space-x-1">
                                    <button @click="enrichCompany(company.id, company.company_master_data?.ai_enriched)" 
                                            class="inline-flex items-center justify-center w-7 h-7 hover:bg-purple-50 rounded group"
                                            :title="company.company_master_data?.ai_enriched ? 'Re-enrich with AI' : 'Enrich with AI'">
                                        <i data-lucide="sparkles" 
                                           :class="company.company_master_data?.ai_enriched ? 'w-4 h-4 text-purple-600' : 'w-3.5 h-3.5 text-gray-400 group-hover:text-purple-600'"></i>
                                    </button>
                                    <button @click="classifyConsulting(company.id)" 
                                            class="inline-flex items-center justify-center w-7 h-7 hover:bg-indigo-50 rounded group"
                                            :title="company.company_master_data?.is_consulting !== null && company.company_master_data?.is_consulting !== undefined ? 'Re-classify consulting status' : 'Classify consulting status'">
                                        <i data-lucide="briefcase" 
                                           :class="company.company_master_data?.is_consulting !== null && company.company_master_data?.is_consulting !== undefined ? 'w-4 h-4 text-indigo-600' : 'w-3.5 h-3.5 text-gray-400 group-hover:text-indigo-600'"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
                <div class="text-sm text-gray-700">
                    Showing <span class="font-medium" x-text="companies.length > 0 ? ((currentPage - 1) * pageSize) + 1 : 0"></span> to 
                    <span class="font-medium" x-text="Math.min(currentPage * pageSize, total)"></span> of 
                    <span class="font-medium" x-text="total"></span> companies
                </div>
                <div class="flex items-center space-x-2">
                    <button @click="previousPage" :disabled="currentPage === 1"
                            class="px-3 py-1 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Previous
                    </button>
                    <span class="text-sm text-gray-700">Page <span class="font-medium" x-text="currentPage"></span> of <span class="font-medium" x-text="totalPages"></span></span>
                    <button @click="nextPage" :disabled="currentPage >= totalPages"
                            class="px-3 py-1 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple Edit Modal -->
    <div x-show="showModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="showModal = false"></div>
            
            <div class="relative bg-white rounded-lg max-w-2xl w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900" x-text="editingCompany?.name"></h3>
                    <button @click="showModal = false" class="text-gray-400 hover:text-gray-500">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- AI Enriched Fields -->
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                        <h4 class="text-sm font-semibold text-purple-900 mb-3 flex items-center">
                            <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i>
                            AI Enriched Fields
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Bedrijfswebsite</label>
                                <input type="url" x-model="formData.bedrijfswebsite" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                       placeholder="https://voorbeeldbedrijf.be">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jobspagina</label>
                                <input type="url" x-model="formData.jobspagina" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                       placeholder="https://voorbeeldbedrijf.be/werken-bij">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email HR</label>
                                    <input type="email" x-model="formData.email_hr" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                           placeholder="hr@voorbeeldbedrijf.be">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email HR Bron</label>
                                    <input type="url" x-model="formData.email_hr_bron" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                           placeholder="https://voorbeeldbedrijf.be/contact">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email Algemeen</label>
                                <input type="email" x-model="formData.email_algemeen" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                       placeholder="info@voorbeeldbedrijf.be">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button @click="showModal = false" 
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button @click="saveMasterData" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Company Detail Modal -->
    <div x-show="showViewModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="showViewModal = false"></div>
            
            <div class="relative bg-white rounded-lg max-w-4xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <!-- Loading State -->
                <div x-show="loadingDetail" class="text-center py-12">
                    <i data-lucide="loader" class="w-8 h-8 mx-auto animate-spin text-blue-500 mb-3"></i>
                    <p class="text-gray-500">Loading company details...</p>
                </div>

                <!-- Content -->
                <template x-if="!loadingDetail && viewingCompany">
                    <div>
                        <div class="flex items-center justify-between mb-4 sticky top-0 bg-white pb-4 border-b">
                            <div>
                                <h3 class="text-xl font-bold text-gray-900" x-text="viewingCompany?.name"></h3>
                                <p class="text-sm text-gray-500" x-text="viewingCompany?.industry"></p>
                            </div>
                            <button @click="showViewModal = false" class="text-gray-400 hover:text-gray-500">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                    <div class="space-y-6">
                        <!-- AI Enrichment Status -->
                        <div class="flex items-center justify-between p-4 rounded-lg bg-purple-50 border border-purple-200">
                            <div class="flex items-center">
                                <i data-lucide="sparkles" class="w-5 h-5 mr-2 text-purple-600"></i>
                                <span class="font-medium text-purple-900">
                                    <span x-text="viewingCompany.company_master_data?.ai_enriched ? 'AI Enriched' : 'Not Enriched'"></span>
                                </span>
                            </div>
                            <span class="text-sm text-gray-500" x-show="viewingCompany.company_master_data?.ai_enriched_at" x-text="new Date(viewingCompany.company_master_data?.ai_enriched_at).toLocaleString()"></span>
                        </div>

                        <!-- Company Size Classification -->
                        <div x-show="viewingCompany.company_master_data?.size_category" class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-orange-900 mb-3 flex items-center">
                                <i data-lucide="building" class="w-4 h-4 mr-2"></i>
                                Company Size Classification
                            </h4>
                            <div class="space-y-3">
                                <!-- Category Badge (Editable) -->
                                <div x-data="{ editing: false, value: viewingCompany.company_master_data?.size_category || '' }">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Category</label>
                                    
                                    <!-- Display mode -->
                                    <div x-show="!editing" class="flex items-center gap-2 mb-2">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium cursor-pointer hover:ring-2 hover:ring-orange-300"
                                              @click="editing = true"
                                              :class="{
                                                  'bg-green-100 text-green-800': value === 'startup',
                                                  'bg-blue-100 text-blue-800': value === 'scaleup',
                                                  'bg-yellow-100 text-yellow-800': value === 'sme',
                                                  'bg-purple-100 text-purple-800': value === 'established_enterprise',
                                                  'bg-indigo-100 text-indigo-800': value === 'corporate',
                                                  'bg-pink-100 text-pink-800': value === 'public_company',
                                                  'bg-gray-100 text-gray-800': value === 'government',
                                                  'bg-slate-100 text-slate-800': value === 'unknown'
                                              }"
                                              x-text="viewingCompany.company_master_data?.category_nl || '-'">
                                        </span>
                                        <span class="text-sm text-gray-600">
                                            Confidence: <span class="font-medium" x-text="(viewingCompany.company_master_data?.size_confidence * 100).toFixed(0) + '%'"></span>
                                        </span>
                                    </div>
                                    
                                    <!-- Edit mode (Dropdown) -->
                                    <div x-show="editing" class="mb-2">
                                        <select x-model="value"
                                                @change="editing = false; updateCompanyField(viewingCompany.id, 'size_category', value).then(() => { viewingCompany.company_master_data.size_category = value; })"
                                                @blur="editing = false"
                                                @keydown.escape="editing = false; value = viewingCompany.company_master_data?.size_category || ''"
                                                class="border border-orange-300 rounded px-2 py-1 text-sm w-full max-w-xs focus:outline-none focus:ring-2 focus:ring-orange-500"
                                                x-init="$watch('editing', val => { if(val) $el.focus() })">
                                            <option value="">-</option>
                                            <option value="startup">Startup</option>
                                            <option value="scaleup">Scale-up</option>
                                            <option value="sme">KMO/SME</option>
                                            <option value="established_enterprise">Gevestigde Onderneming</option>
                                            <option value="corporate">Corporate</option>
                                            <option value="public_company">Beursgenoteerd</option>
                                            <option value="government">Overheid</option>
                                            <option value="unknown">Onbekend</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Multilingual category labels (auto-generated by database) -->
                                    <div class="text-xs text-gray-600 space-y-1">
                                        <div x-show="viewingCompany.company_master_data?.category_nl">
                                            üá≥üá± <span x-text="viewingCompany.company_master_data?.category_nl"></span>
                                        </div>
                                        <div x-show="viewingCompany.company_master_data?.category_en">
                                            üá¨üáß <span x-text="viewingCompany.company_master_data?.category_en"></span>
                                        </div>
                                        <div x-show="viewingCompany.company_master_data?.category_fr">
                                            üá´üá∑ <span x-text="viewingCompany.company_master_data?.category_fr"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Key Arguments -->
                                <div x-show="viewingCompany.company_master_data?.size_key_arguments">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Key Arguments</label>
                                    <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                                        <template x-for="arg in (Array.isArray(viewingCompany.company_master_data?.size_key_arguments) ? viewingCompany.company_master_data?.size_key_arguments : JSON.parse(viewingCompany.company_master_data?.size_key_arguments || '[]'))" :key="arg">
                                            <li x-text="arg"></li>
                                        </template>
                                    </ul>
                                </div>
                                
                                <!-- Sources -->
                                <div x-show="viewingCompany.company_master_data?.size_sources">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Sources</label>
                                    <div class="space-y-1">
                                        <template x-for="source in (Array.isArray(viewingCompany.company_master_data?.size_sources) ? viewingCompany.company_master_data?.size_sources : JSON.parse(viewingCompany.company_master_data?.size_sources || '[]'))" :key="source">
                                            <a :href="source" target="_blank" class="text-xs text-blue-600 hover:underline block break-all" x-text="source"></a>
                                        </template>
                                    </div>
                                </div>
                                
                                <!-- Enrichment Date -->
                                <div x-show="viewingCompany.company_master_data?.size_enriched_at" class="text-xs text-gray-500 pt-2 border-t">
                                    Classified on <span x-text="new Date(viewingCompany.company_master_data?.size_enriched_at).toLocaleString()"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Consulting Check -->
                        <div x-show="viewingCompany.company_master_data?.is_consulting !== null && viewingCompany.company_master_data?.is_consulting !== undefined" class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-indigo-900 mb-3 flex items-center">
                                <i data-lucide="briefcase" class="w-4 h-4 mr-2"></i>
                                Consulting Company
                            </h4>
                            <div class="flex items-center gap-3">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                                      :class="viewingCompany.company_master_data?.is_consulting ? 'bg-indigo-100 text-indigo-800' : 'bg-gray-100 text-gray-800'">
                                    <span x-text="viewingCompany.company_master_data?.is_consulting ? '‚úì Yes - This is a consulting company' : '‚úó No - Not a consulting company'"></span>
                                </span>
                            </div>
                        </div>

                        <!-- Hiring Model -->
                        <div x-show="viewingCompany.company_master_data?.hiring_model" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-blue-900 mb-3 flex items-center">
                                <i data-lucide="briefcase" class="w-4 h-4 mr-2"></i>
                                Hiring Model
                            </h4>
                            <div class="space-y-3">
                                <!-- Hiring Model Badge -->
                                <div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"
                                              :class="{
                                                  'bg-purple-100 text-purple-800': viewingCompany.company_master_data?.hiring_model === 'recruitment',
                                                  'bg-green-100 text-green-800': viewingCompany.company_master_data?.hiring_model === 'direct',
                                                  'bg-gray-100 text-gray-800': viewingCompany.company_master_data?.hiring_model === 'unknown',
                                              }"
                                              x-text="viewingCompany.company_master_data?.hiring_model_en || viewingCompany.company_master_data?.hiring_model">
                                        </span>
                                    </div>
                                    <!-- Multilingual hiring model labels -->
                                    <div class="text-xs text-gray-600 space-y-1">
                                        <div x-show="viewingCompany.company_master_data?.hiring_model_en">
                                            üá¨üáß <span x-text="viewingCompany.company_master_data?.hiring_model_en"></span>
                                        </div>
                                        <div x-show="viewingCompany.company_master_data?.hiring_model_nl">
                                            üá≥üá± <span x-text="viewingCompany.company_master_data?.hiring_model_nl"></span>
                                        </div>
                                        <div x-show="viewingCompany.company_master_data?.hiring_model_fr">
                                            üá´üá∑ <span x-text="viewingCompany.company_master_data?.hiring_model_fr"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Explanation -->
                                <div class="text-xs text-gray-600 bg-white rounded p-2">
                                    <template x-if="viewingCompany.company_master_data?.hiring_model === 'recruitment'">
                                        <p>üè¢ This company provides recruitment/staffing services (interim, headhunting, RPO)</p>
                                    </template>
                                    <template x-if="viewingCompany.company_master_data?.hiring_model === 'direct'">
                                        <p>üè≠ This company hires directly for its own organization</p>
                                    </template>
                                    <template x-if="viewingCompany.company_master_data?.hiring_model === 'unknown'">
                                        <p>‚ùì Hiring model could not be determined with confidence</p>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <!-- AI Enriched Data -->
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-purple-900 mb-3 flex items-center">
                                <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i>
                                AI Enriched Information
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Bedrijfswebsite</label>
                                    <a x-show="viewingCompany.company_master_data?.bedrijfswebsite" :href="viewingCompany.company_master_data?.bedrijfswebsite" target="_blank" class="text-sm text-blue-600 hover:underline break-all" x-text="viewingCompany.company_master_data?.bedrijfswebsite"></a>
                                    <span x-show="!viewingCompany.company_master_data?.bedrijfswebsite" class="text-sm text-gray-400">-</span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Jobspagina</label>
                                    <a x-show="viewingCompany.company_master_data?.jobspagina" :href="viewingCompany.company_master_data?.jobspagina" target="_blank" class="text-sm text-blue-600 hover:underline break-all" x-text="viewingCompany.company_master_data?.jobspagina"></a>
                                    <span x-show="!viewingCompany.company_master_data?.jobspagina" class="text-sm text-gray-400">-</span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Email HR</label>
                                    <a x-show="viewingCompany.company_master_data?.email_hr" :href="'mailto:' + viewingCompany.company_master_data?.email_hr" class="text-sm text-blue-600 hover:underline" x-text="viewingCompany.company_master_data?.email_hr"></a>
                                    <span x-show="!viewingCompany.company_master_data?.email_hr" class="text-sm text-gray-400">-</span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Email HR Bron</label>
                                    <a x-show="viewingCompany.company_master_data?.email_hr_bron" :href="viewingCompany.company_master_data?.email_hr_bron" target="_blank" class="text-sm text-blue-600 hover:underline break-all" x-text="viewingCompany.company_master_data?.email_hr_bron"></a>
                                    <span x-show="!viewingCompany.company_master_data?.email_hr_bron" class="text-sm text-gray-400">-</span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Email Algemeen</label>
                                    <a x-show="viewingCompany.company_master_data?.email_algemeen" :href="'mailto:' + viewingCompany.company_master_data?.email_algemeen" class="text-sm text-blue-600 hover:underline" x-text="viewingCompany.company_master_data?.email_algemeen"></a>
                                    <span x-show="!viewingCompany.company_master_data?.email_algemeen" class="text-sm text-gray-400">-</span>
                                </div>
                            </div>
                            
                            <!-- Company Descriptions (Multilingual) -->
                            <div class="mt-4 space-y-3">
                                <div x-show="viewingCompany.company_master_data?.bedrijfsomschrijving_nl">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">üá≥üá± Bedrijfsomschrijving (NL)</label>
                                    <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="viewingCompany.company_master_data?.bedrijfsomschrijving_nl || '-'"></p>
                                </div>
                                <div x-show="viewingCompany.company_master_data?.bedrijfsomschrijving_fr">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">üá´üá∑ Description de l'entreprise (FR)</label>
                                    <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="viewingCompany.company_master_data?.bedrijfsomschrijving_fr || '-'"></p>
                                </div>
                                <div x-show="viewingCompany.company_master_data?.bedrijfsomschrijving_en">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">üá¨üáß Company Description (EN)</label>
                                    <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="viewingCompany.company_master_data?.bedrijfsomschrijving_en || '-'"></p>
                                </div>
                            </div>
                            
                            <!-- Additional Info -->
                            <div class="mt-4 grid grid-cols-2 gap-4">
                                <div x-show="viewingCompany.company_master_data?.sector_en">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Sector</label>
                                    <p class="text-sm text-gray-900" x-text="viewingCompany.company_master_data?.sector_en || '-'"></p>
                                </div>
                                <div x-show="viewingCompany.company_master_data?.aantal_werknemers">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Aantal Werknemers</label>
                                    <p class="text-sm text-gray-900" x-text="viewingCompany.company_master_data?.aantal_werknemers || '-'"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Weetjes (Factlets) -->
                        <div x-show="viewingCompany.company_master_data?.weetjes && (Array.isArray(viewingCompany.company_master_data?.weetjes) ? viewingCompany.company_master_data?.weetjes : JSON.parse(viewingCompany.company_master_data?.weetjes || '[]')).length > 0" 
                             class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-blue-900 mb-3 flex items-center">
                                <i data-lucide="lightbulb" class="w-4 h-4 mr-2"></i>
                                Weetjes (Factlets)
                            </h4>
                            <div class="space-y-4">
                                <template x-for="(weetje, index) in (Array.isArray(viewingCompany.company_master_data?.weetjes) ? viewingCompany.company_master_data?.weetjes : JSON.parse(viewingCompany.company_master_data?.weetjes || '[]'))" :key="index">
                                    <div class="bg-white rounded-lg p-3 border border-blue-100">
                                        <!-- Category Badge -->
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium"
                                                  :class="{
                                                      'bg-green-100 text-green-800': ['founding_fact', 'global_reach', 'employee_scale', 'hq_location', 'industry_position', 'heritage_milestone'].includes(weetje.category),
                                                      'bg-purple-100 text-purple-800': ['recent_award', 'notable_customer', 'funding_event', 'esg_initiative', 'product_milestone', 'career_growth', 'market_presence'].includes(weetje.category)
                                                  }">
                                                <span x-text="weetje.category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())"></span>
                                            </span>
                                            <span class="text-xs text-gray-500">
                                                <span x-text="(weetje.confidence * 100).toFixed(0) + '%'"></span> confidence
                                            </span>
                                        </div>
                                        
                                        <!-- Multilingual Texts -->
                                        <div class="space-y-2 text-sm">
                                            <div x-show="weetje.text_en">
                                                <span class="font-medium text-gray-600">üá¨üáß</span>
                                                <span class="text-gray-800" x-text="weetje.text_en"></span>
                                            </div>
                                            <div x-show="weetje.text_nl">
                                                <span class="font-medium text-gray-600">üá≥üá±</span>
                                                <span class="text-gray-800" x-text="weetje.text_nl"></span>
                                            </div>
                                            <div x-show="weetje.text_fr">
                                                <span class="font-medium text-gray-600">üá´üá∑</span>
                                                <span class="text-gray-800" x-text="weetje.text_fr"></span>
                                            </div>
                                        </div>
                                        
                                        <!-- Source and Date -->
                                        <div class="mt-2 pt-2 border-t border-gray-100 flex items-center justify-between text-xs">
                                            <a x-show="weetje.source" :href="weetje.source" target="_blank" 
                                               class="text-blue-600 hover:underline flex items-center">
                                                <i data-lucide="external-link" class="w-3 h-3 mr-1"></i>
                                                <span class="truncate max-w-[200px]" x-text="weetje.source"></span>
                                            </a>
                                            <span x-show="weetje.date_verified" class="text-gray-500" x-text="'Verified: ' + weetje.date_verified"></span>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Company Info -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3">Company Information</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">LinkedIn Company ID</label>
                                    <p class="text-sm text-gray-900" x-text="viewingCompany.linkedin_company_id || '-'"></p>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Industry</label>
                                    <p class="text-sm text-gray-900" x-text="viewingCompany.industry || '-'"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex justify-between items-center pt-4 border-t">
                            <a :href="`/jobs?company_id=${viewingCompany.id}`" 
                               class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50">
                                <i data-lucide="briefcase" class="w-4 h-4 mr-2"></i>
                                View Jobs
                            </a>
                            <div class="flex space-x-3">
                                <button @click="showViewModal = false" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Close</button>
                                <button @click="editCompany(viewingCompany); showViewModal = false" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Edit Company</button>
                            </div>
                        </div>
                    </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function companiesPage() {
    return {
        companies: [],
        loading: true,
        search: '',
        total: 0,
        withMasterData: 0,
        verified: 0,
        showModal: false,
        showViewModal: false,
        loadingDetail: false,
        editingCompany: null,
        viewingCompany: null,
        formData: {},
        currentPage: 1,
        pageSize: 100,
        totalPages: 1,
        selectedCompanies: [],
        enriching: false,
        classifyingConsulting: false,
        aiStats: {
            total: 0,
            enriched: 0,
            unenriched: 0,
            percentage_enriched: 0
        },
        sizeStats: {
            total: 0,
            classified: 0,
            pending: 0,
            categories: {}
        },
        
        // Helper to get API base URL with forced HTTPS in production
        getApiBaseUrl() {
            const origin = window.location.origin;
            // Force HTTPS if on Railway production (or any production domain)
            if (origin.includes('railway.app') && origin.startsWith('http://')) {
                return origin.replace('http://', 'https://');
            }
            return origin;
        },
        
        async init() {
            await this.loadCompanies();
            await this.loadAIStats();
            await this.loadSizeStats();
            this.$nextTick(() => lucide.createIcons());
        },
        
        
        async loadCompanies() {
            this.loading = true;
            try {
                console.log(`Fetching companies page ${this.currentPage} from API`);
                const params = new URLSearchParams();
                if (this.search) params.append('search', this.search);
                params.append('limit', this.pageSize);
                params.append('offset', (this.currentPage - 1) * this.pageSize);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout
                
                // Force HTTPS for Railway
                const apiUrl = `${this.getApiBaseUrl()}/api/companies/?${params}`;
                
                const response = await fetch(apiUrl, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                this.companies = data.companies || [];
                this.total = data.total || 0;
                this.totalPages = Math.ceil(this.total / this.pageSize);
                
                // Calculate stats
                this.withMasterData = this.companies.filter(c => c.company_master_data).length;
                this.verified = this.companies.filter(c => c.company_master_data?.verified).length;
                
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to load companies:', error);
                this.companies = [];
                this.total = 0;
                alert('Failed to load companies: ' + error.message);
            } finally {
                this.loading = false;
            }
        },
        
        async nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                await this.loadCompanies();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        },
        
        async previousPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                await this.loadCompanies();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        },
        
        formatRevenue(masterData) {
            if (!masterData) return '-';
            if (masterData.revenue_range) return masterData.revenue_range;
            if (masterData.revenue_eur) {
                const revenue = masterData.revenue_eur;
                if (revenue >= 1000000) {
                    return '‚Ç¨' + (revenue / 1000000).toFixed(1) + 'M';
                } else if (revenue >= 1000) {
                    return '‚Ç¨' + (revenue / 1000).toFixed(0) + 'K';
                }
                return '‚Ç¨' + revenue;
            }
            return '-';
        },
        
        async viewCompany(company) {
            console.log('üîç Opening company detail for ID:', company.id);
            this.showViewModal = true;
            this.loadingDetail = true;
            this.viewingCompany = null; // Clear previous data
            
            try {
                const apiUrl = `${this.getApiBaseUrl()}/api/companies/${company.id}`;
                console.log('üì° Fetching company detail from:', apiUrl);
                
                const response = await fetch(apiUrl);
                console.log('üì• Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API Error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                this.viewingCompany = await response.json();
                console.log('‚úÖ Company detail loaded:', this.viewingCompany.name);
                console.log('üìä Master data present:', !!this.viewingCompany.company_master_data);
                
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('‚ùå Failed to load company detail:', error);
                alert('Failed to load company details: ' + error.message);
                this.showViewModal = false;
            } finally {
                this.loadingDetail = false;
            }
        },
        
        editCompany(company) {
            this.editingCompany = company;
            this.formData = {
                // AI Enriched fields only
                bedrijfswebsite: company.company_master_data?.bedrijfswebsite || '',
                jobspagina: company.company_master_data?.jobspagina || '',
                email_hr: company.company_master_data?.email_hr || '',
                email_hr_bron: company.company_master_data?.email_hr_bron || '',
                email_algemeen: company.company_master_data?.email_algemeen || ''
            };
            this.showModal = true;
            this.$nextTick(() => lucide.createIcons());
        },
        
        async saveMasterData() {
            try {
                const companyId = this.editingCompany.id;
                const masterData = this.editingCompany.company_master_data;
                const hasMasterData = masterData && (Array.isArray(masterData) ? masterData.length > 0 : true);
                
                // Clean the data: remove empty strings and convert string numbers to integers
                const cleanedData = {};
                for (const [key, value] of Object.entries(this.formData)) {
                    // Skip empty/null/undefined
                    if (value === '' || value === null || value === undefined) {
                        continue;
                    }
                    // Convert string numbers to integers for numeric fields
                    if ((key === 'employee_count' || key === 'revenue_eur') && typeof value === 'string') {
                        const numValue = parseInt(value, 10);
                        if (!isNaN(numValue)) {
                            cleanedData[key] = numValue;
                        }
                    } else {
                        cleanedData[key] = value;
                    }
                }
                
                console.log('Cleaned data to send:', cleanedData);
                
                const url = `${this.getApiBaseUrl()}/api/companies/${companyId}/master-data`;
                const method = hasMasterData ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cleanedData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    console.error('API Error:', response.status, errorData);
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                this.showModal = false;
                await this.loadCompanies();
                alert('Master data saved successfully!');
            } catch (error) {
                console.error('Failed to save:', error);
                alert('Failed to save master data: ' + error.message);
            }
        },
        
        
        async loadAIStats() {
            try {
                const response = await fetch(`${this.getApiBaseUrl()}/api/companies/enrich/stats`);
                this.aiStats = await response.json();
            } catch (error) {
                console.error('Failed to load AI stats:', error);
            }
        },
        
        async loadSizeStats() {
            try {
                const response = await fetch(`${this.getApiBaseUrl()}/api/companies/size-classification/stats`);
                this.sizeStats = await response.json();
            } catch (error) {
                console.error('Failed to load size stats:', error);
            }
        },
        
        async updateCompanyField(companyId, field, value) {
            try {
                console.log(`Updating company ${companyId}: ${field} = ${value}`);
                
                // Update via API
                const response = await fetch(`${this.getApiBaseUrl()}/api/companies/${companyId}/master-data`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        [field]: value
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                // Update local data
                const company = this.companies.find(c => c.id === companyId);
                if (company && company.company_master_data) {
                    company.company_master_data[field] = value;
                }
                
                console.log(`‚úÖ Updated ${field} successfully`);
            } catch (error) {
                console.error('Failed to update field:', error);
                alert(`Failed to update ${field}: ${error.message}`);
                // Reload to revert changes
                await this.loadCompanies();
            }
        },
        
        async updateCompanyFields(companyId, fields) {
            try {
                console.log(`Updating company ${companyId}:`, fields);
                
                // Update via API
                const response = await fetch(`${this.getApiBaseUrl()}/api/companies/${companyId}/master-data`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(fields)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                // Update local data
                const company = this.companies.find(c => c.id === companyId);
                if (company && company.company_master_data) {
                    Object.assign(company.company_master_data, fields);
                }
                
                console.log(`‚úÖ Updated fields successfully`);
            } catch (error) {
                console.error('Failed to update fields:', error);
                alert(`Failed to update fields: ${error.message}`);
                // Reload to revert changes
                await this.loadCompanies();
            }
        },
        
        toggleCompanySelection(companyId) {
            const index = this.selectedCompanies.indexOf(companyId);
            if (index > -1) {
                this.selectedCompanies.splice(index, 1);
            } else {
                this.selectedCompanies.push(companyId);
            }
        },
        
        toggleAll() {
            if (this.selectedCompanies.length === this.companies.length) {
                this.selectedCompanies = [];
            } else {
                this.selectedCompanies = this.companies.map(c => c.id);
            }
        },
        
        async enrichSelected() {
            if (this.selectedCompanies.length === 0) {
                alert('No companies selected');
                return;
            }
            
            if (!confirm(`Enrich ${this.selectedCompanies.length} selected company(ies)? This may take a few minutes.`)) {
                return;
            }
            
            this.enriching = true;
            
            try {
                const response = await fetch(`${this.getApiBaseUrl()}/api/companies/enrich/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.selectedCompanies)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Enrichment failed');
                }
                
                const result = await response.json();
                
                alert(
                    `‚úÖ Batch enrichment started in background!\n\n` +
                    `${this.selectedCompanies.length} companies will be enriched.\n\n` +
                    `‚è±Ô∏è This will take several minutes (1-2 min per company).\n\n` +
                    `Refresh the page in a few minutes to see the results.`
                );
                
                // Clear selection
                this.selectedCompanies = [];
                
                // Reload data
                await this.loadCompanies();
                await this.loadAIStats();
                await this.loadSizeStats();
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to enrich companies:', error);
                alert('Failed to enrich companies: ' + error.message);
            } finally {
                this.enriching = false;
            }
        },
        
        async enrichAllUnenriched() {
            const maxBatch = 50; // Server-side limit to prevent timeouts
            const total = this.aiStats.unenriched;
            const willProcess = Math.min(total, maxBatch);
            
            let message = `Enrich ${willProcess} companies?`;
            if (total > maxBatch) {
                message = `‚ö†Ô∏è You have ${total} unenriched companies.\n\n` +
                         `Due to server timeout limits, only ${maxBatch} companies will be enriched per batch.\n\n` +
                         `After this batch completes, click "Enrich All" again to process the next ${maxBatch}.\n\n` +
                         `Continue with first batch of ${maxBatch} companies?`;
            }
            
            if (!confirm(message)) {
                return;
            }
            
            this.enriching = true;
            
            try {
                // Get unenriched company IDs (limit to 1000 but server will process max 50)
                const response = await fetch(`${this.getApiBaseUrl()}/api/companies/enrich/unenriched?limit=1000`);
                const data = await response.json();
                
                if (data.company_ids.length === 0) {
                    alert('No unenriched companies found');
                    return;
                }
                
                // Enrich in batch (server will limit to 50)
                const enrichResponse = await fetch(`${this.getApiBaseUrl()}/api/companies/enrich/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data.company_ids)
                });
                
                if (!enrichResponse.ok) {
                    const error = await enrichResponse.json();
                    throw new Error(error.detail || 'Enrichment failed');
                }
                
                const result = await enrichResponse.json();
                const processed = Math.min(data.company_ids.length, maxBatch);
                const remaining = Math.max(0, total - processed);
                
                let successMessage = `‚úÖ Batch enrichment started!\n\n` +
                    `Processing: ${processed} companies\n` +
                    `‚è±Ô∏è Time: ~${processed * 2} minutes (2 min/company)\n\n`;
                
                if (remaining > 0) {
                    successMessage += `üìä Remaining: ${remaining} companies\n` +
                                    `üí° Click "Enrich All" again after this batch completes to process the next batch.\n\n`;
                }
                
                successMessage += `Refresh the page in ${processed * 2} minutes to see results.`;
                
                alert(successMessage);
                
                await this.loadCompanies();
                await this.loadAIStats();
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to enrich companies:', error);
                alert('Failed to enrich companies: ' + error.message);
            } finally {
                this.enriching = false;
            }
        },
        
        async enrichCompany(companyId, isEnriched) {
            const action = isEnriched ? 're-enrich' : 'enrich';
            if (!confirm(`${isEnriched ? 'Re-enrich' : 'Enrich'} this company with AI? This will update all company information.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${this.getApiBaseUrl()}/api/companies/${companyId}/enrich`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Enrichment failed');
                }
                
                const result = await response.json();
                alert(`‚úÖ Company enrichment started in background!\n\nCompany: ${result.company_name}\n\n‚è±Ô∏è This will take 1-2 minutes to complete.\n\nRefresh the page in a few minutes to see the updated data.`);
                
                // Reload data after a short delay
                setTimeout(async () => {
                    await this.loadCompanies();
                    await this.loadAIStats();
                    await this.loadSizeStats();
                    this.$nextTick(() => lucide.createIcons());
                }, 2000);
            } catch (error) {
                console.error('Failed to enrich company:', error);
                alert('Failed to enrich company: ' + error.message);
            }
        },
        
        async classifyConsulting(companyId) {
            if (!confirm('Classify this company\'s consulting status? This will determine if the company is primarily a consulting firm.')) {
                return;
            }
            
            try {
                const response = await fetch(`${this.getApiBaseUrl()}/api/companies/${companyId}/classify-consulting`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Classification failed');
                }
                
                const result = await response.json();
                alert(`‚úÖ Consulting classification started in background!\n\nCompany: ${result.company_name}\n\n‚è±Ô∏è This will take 10-30 seconds to complete.\n\nRefresh the page in a minute to see the result.`);
                
                // Reload data after a short delay
                setTimeout(async () => {
                    await this.loadCompanies();
                    this.$nextTick(() => lucide.createIcons());
                }, 2000);
            } catch (error) {
                console.error('Failed to classify consulting status:', error);
                alert('Failed to classify consulting status: ' + error.message);
            }
        },
        
        async classifyAllEnriched() {
            if (!confirm(`Classify all ${this.aiStats.enriched} enriched companies for consulting status? This may take several minutes.`)) {
                return;
            }
            
            this.classifyingConsulting = true;
            
            try {
                const response = await fetch(`${this.getApiBaseUrl()}/api/companies/classify-consulting/all-enriched`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Classification failed');
                }
                
                const result = await response.json();
                alert(`‚úÖ Consulting classification started in background!\n\n${result.company_count} enriched companies will be classified.\n\nThis will take several minutes. Refresh the page later to see the results.`);
                
                // Reload data after a delay
                setTimeout(async () => {
                    await this.loadCompanies();
                    this.$nextTick(() => lucide.createIcons());
                }, 3000);
            } catch (error) {
                console.error('Failed to classify consulting status:', error);
                alert('Failed to classify consulting status: ' + error.message);
            } finally {
                this.classifyingConsulting = false;
            }
        }
    }
}
</script>
{% endblock %}
