{% extends "base.html" %}

{% block title %}Companies - everyjob{% endblock %}

{% block content %}
<div x-data="companiesPage()">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Companies</h1>
                <p class="text-gray-600 mt-1">Manage company master data</p>
            </div>
            <div class="flex items-center space-x-3">
                <!-- AI Enrichment Stats -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg px-4 py-2">
                    <div class="text-sm text-purple-900">
                        <span class="font-semibold">AI Enriched:</span>
                        <span x-text="aiStats.enriched"></span> / <span x-text="aiStats.total"></span>
                        (<span x-text="aiStats.percentage_enriched"></span>%)
                    </div>
                </div>
                <!-- Enrich Selected Button -->
                <button @click="enrichSelected" 
                        :disabled="enriching || selectedCompanies.length === 0"
                        x-show="selectedCompanies.length > 0"
                        class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                    <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i>
                    <span x-show="!enriching">Enrich Selected (<span x-text="selectedCompanies.length"></span>)</span>
                    <span x-show="enriching">Enriching...</span>
                </button>
                <!-- Enrich All Button -->
                <button @click="enrichAllUnenriched" 
                        :disabled="enriching || aiStats.unenriched === 0"
                        class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                    <i data-lucide="zap" class="w-4 h-4 mr-2"></i>
                    <span x-show="!enriching">Enrich All (<span x-text="aiStats.unenriched"></span>)</span>
                    <span x-show="enriching">Enriching...</span>
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Companies</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="total"></p>
                    </div>
                    <i data-lucide="building-2" class="w-8 h-8 text-blue-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">With Master Data</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="withMasterData"></p>
                    </div>
                    <i data-lucide="database" class="w-8 h-8 text-green-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Verified</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="verified"></p>
                    </div>
                    <i data-lucide="check-circle" class="w-8 h-8 text-purple-500"></i>
                </div>
            </div>
        </div>

        <!-- Search -->
        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <input type="text" x-model="search" @input="invalidateCache(); loadCompanies()" 
                   placeholder="Search companies..."
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
    </div>

    <!-- Companies Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div x-show="loading" class="text-center py-12">
            <i data-lucide="loader" class="w-8 h-8 mx-auto animate-spin text-blue-500 mb-3"></i>
            <p class="text-gray-500">Loading companies...</p>
        </div>

        <div x-show="!loading && companies.length === 0" class="text-center py-12">
            <i data-lucide="building-2" class="w-12 h-12 mx-auto text-gray-300 mb-3"></i>
            <p class="text-gray-500">No companies found</p>
        </div>

        <div x-show="!loading && companies.length > 0">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left">
                                <input type="checkbox" @change="toggleAll" class="rounded border-gray-300">
                            </th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Industry</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"><i data-lucide="globe" class="w-4 h-4 inline"></i></th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"><i data-lucide="briefcase" class="w-4 h-4 inline"></i></th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email HR</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"><i data-lucide="link" class="w-4 h-4 inline"></i></th>
                            <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email Alg.</th>
                        </tr>
                    </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="company in companies" :key="company.id">
                        <tr class="hover:bg-gray-50 cursor-pointer" @click="viewCompany(company)">
                            <!-- Checkbox -->
                            <td class="px-4 py-3" @click.stop>
                                <input type="checkbox" 
                                       :checked="selectedCompanies.includes(company.id)"
                                       @change="toggleCompanySelection(company.id)"
                                       class="rounded border-gray-300">
                            </td>
                            <!-- Company Name & Logo -->
                            <td class="px-3 py-2">
                                <div class="flex items-center min-w-[180px]">
                                    <img x-show="company.logo_url" :src="company.logo_url" :alt="company.name" 
                                         class="w-7 h-7 rounded object-cover mr-2 flex-shrink-0">
                                    <div x-show="!company.logo_url" class="w-7 h-7 rounded bg-gray-100 flex items-center justify-center mr-2 flex-shrink-0">
                                        <i data-lucide="building-2" class="w-4 h-4 text-gray-400"></i>
                                    </div>
                                    <div class="text-sm font-medium text-gray-900 truncate" x-text="company.name"></div>
                                </div>
                            </td>
                            <!-- Industry -->
                            <td class="px-2 py-2">
                                <div class="text-xs text-gray-600 truncate max-w-[120px]" :title="company.industry" x-text="company.industry || '-'"></div>
                            </td>
                            <!-- Bedrijfswebsite -->
                            <td class="px-2 py-2 text-center" @click.stop>
                                <a x-show="company.company_master_data?.bedrijfswebsite" 
                                   :href="company.company_master_data?.bedrijfswebsite" 
                                   target="_blank"
                                   class="inline-flex items-center text-blue-600 hover:text-blue-800"
                                   :title="company.company_master_data?.bedrijfswebsite">
                                    <i data-lucide="globe" class="w-4 h-4"></i>
                                </a>
                                <span x-show="!company.company_master_data?.bedrijfswebsite" class="text-gray-300">
                                    <i data-lucide="globe" class="w-4 h-4"></i>
                                </span>
                            </td>
                            <!-- Jobspagina -->
                            <td class="px-2 py-2 text-center" @click.stop>
                                <a x-show="company.company_master_data?.jobspagina" 
                                   :href="company.company_master_data?.jobspagina" 
                                   target="_blank"
                                   class="inline-flex items-center text-blue-600 hover:text-blue-800"
                                   :title="company.company_master_data?.jobspagina">
                                    <i data-lucide="briefcase" class="w-4 h-4"></i>
                                </a>
                                <span x-show="!company.company_master_data?.jobspagina" class="text-gray-300">
                                    <i data-lucide="briefcase" class="w-4 h-4"></i>
                                </span>
                            </td>
                            <!-- Email HR -->
                            <td class="px-2 py-2">
                                <a x-show="company.company_master_data?.email_hr" 
                                   :href="'mailto:' + company.company_master_data?.email_hr" 
                                   class="text-xs text-blue-600 hover:text-blue-800 hover:underline truncate block max-w-[140px]"
                                   :title="company.company_master_data?.email_hr"
                                   x-text="company.company_master_data?.email_hr"></a>
                                <span x-show="!company.company_master_data?.email_hr" class="text-xs text-gray-400">-</span>
                            </td>
                            <!-- Email HR Bron -->
                            <td class="px-2 py-2 text-center" @click.stop>
                                <a x-show="company.company_master_data?.email_hr_bron" 
                                   :href="company.company_master_data?.email_hr_bron" 
                                   target="_blank"
                                   class="inline-flex items-center text-blue-600 hover:text-blue-800"
                                   :title="company.company_master_data?.email_hr_bron">
                                    <i data-lucide="link" class="w-4 h-4"></i>
                                </a>
                                <span x-show="!company.company_master_data?.email_hr_bron" class="text-gray-300">
                                    <i data-lucide="link" class="w-4 h-4"></i>
                                </span>
                            </td>
                            <!-- Email Algemeen -->
                            <td class="px-2 py-2">
                                <a x-show="company.company_master_data?.email_algemeen" 
                                   :href="'mailto:' + company.company_master_data?.email_algemeen" 
                                   class="text-xs text-blue-600 hover:text-blue-800 hover:underline truncate block max-w-[140px]"
                                   :title="company.company_master_data?.email_algemeen"
                                   x-text="company.company_master_data?.email_algemeen"></a>
                                <span x-show="!company.company_master_data?.email_algemeen" class="text-xs text-gray-400">-</span>
                            </td>
                        </tr>
                    </template>
                </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
                <div class="text-sm text-gray-700">
                    Showing <span class="font-medium" x-text="companies.length > 0 ? ((currentPage - 1) * pageSize) + 1 : 0"></span> to 
                    <span class="font-medium" x-text="Math.min(currentPage * pageSize, total)"></span> of 
                    <span class="font-medium" x-text="total"></span> companies
                </div>
                <div class="flex items-center space-x-2">
                    <button @click="previousPage" :disabled="currentPage === 1"
                            class="px-3 py-1 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Previous
                    </button>
                    <span class="text-sm text-gray-700">Page <span class="font-medium" x-text="currentPage"></span> of <span class="font-medium" x-text="totalPages"></span></span>
                    <button @click="nextPage" :disabled="currentPage >= totalPages"
                            class="px-3 py-1 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple Edit Modal -->
    <div x-show="showModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="showModal = false"></div>
            
            <div class="relative bg-white rounded-lg max-w-2xl w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900" x-text="editingCompany?.name"></h3>
                    <button @click="showModal = false" class="text-gray-400 hover:text-gray-500">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <!-- AI Enriched Fields -->
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                        <h4 class="text-sm font-semibold text-purple-900 mb-3 flex items-center">
                            <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i>
                            AI Enriched Fields
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Bedrijfswebsite</label>
                                <input type="url" x-model="formData.bedrijfswebsite" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                       placeholder="https://voorbeeldbedrijf.be">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jobspagina</label>
                                <input type="url" x-model="formData.jobspagina" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                       placeholder="https://voorbeeldbedrijf.be/werken-bij">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email HR</label>
                                    <input type="email" x-model="formData.email_hr" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                           placeholder="hr@voorbeeldbedrijf.be">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email HR Bron</label>
                                    <input type="url" x-model="formData.email_hr_bron" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                           placeholder="https://voorbeeldbedrijf.be/contact">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email Algemeen</label>
                                <input type="email" x-model="formData.email_algemeen" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                       placeholder="info@voorbeeldbedrijf.be">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button @click="showModal = false" 
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button @click="saveMasterData" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Company Detail Modal -->
    <div x-show="showViewModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="showViewModal = false"></div>
            
            <div class="relative bg-white rounded-lg max-w-4xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4 sticky top-0 bg-white pb-4 border-b">
                    <div>
                        <h3 class="text-xl font-bold text-gray-900" x-text="viewingCompany?.name"></h3>
                        <p class="text-sm text-gray-500" x-text="viewingCompany?.industry"></p>
                    </div>
                    <button @click="showViewModal = false" class="text-gray-400 hover:text-gray-500">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <template x-if="viewingCompany">
                    <div class="space-y-6">
                        <!-- AI Enrichment Status -->
                        <div class="flex items-center justify-between p-4 rounded-lg bg-purple-50 border border-purple-200">
                            <div class="flex items-center">
                                <i data-lucide="sparkles" class="w-5 h-5 mr-2 text-purple-600"></i>
                                <span class="font-medium text-purple-900">
                                    <span x-text="viewingCompany.company_master_data?.ai_enriched ? 'AI Enriched' : 'Not Enriched'"></span>
                                </span>
                            </div>
                            <span class="text-sm text-gray-500" x-show="viewingCompany.company_master_data?.ai_enriched_at" x-text="new Date(viewingCompany.company_master_data?.ai_enriched_at).toLocaleString()"></span>
                        </div>

                        <!-- AI Enriched Data -->
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-purple-900 mb-3 flex items-center">
                                <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i>
                                AI Enriched Information
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Bedrijfswebsite</label>
                                    <a x-show="viewingCompany.company_master_data?.bedrijfswebsite" :href="viewingCompany.company_master_data?.bedrijfswebsite" target="_blank" class="text-sm text-blue-600 hover:underline break-all" x-text="viewingCompany.company_master_data?.bedrijfswebsite"></a>
                                    <span x-show="!viewingCompany.company_master_data?.bedrijfswebsite" class="text-sm text-gray-400">-</span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Jobspagina</label>
                                    <a x-show="viewingCompany.company_master_data?.jobspagina" :href="viewingCompany.company_master_data?.jobspagina" target="_blank" class="text-sm text-blue-600 hover:underline break-all" x-text="viewingCompany.company_master_data?.jobspagina"></a>
                                    <span x-show="!viewingCompany.company_master_data?.jobspagina" class="text-sm text-gray-400">-</span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Email HR</label>
                                    <a x-show="viewingCompany.company_master_data?.email_hr" :href="'mailto:' + viewingCompany.company_master_data?.email_hr" class="text-sm text-blue-600 hover:underline" x-text="viewingCompany.company_master_data?.email_hr"></a>
                                    <span x-show="!viewingCompany.company_master_data?.email_hr" class="text-sm text-gray-400">-</span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Email HR Bron</label>
                                    <a x-show="viewingCompany.company_master_data?.email_hr_bron" :href="viewingCompany.company_master_data?.email_hr_bron" target="_blank" class="text-sm text-blue-600 hover:underline break-all" x-text="viewingCompany.company_master_data?.email_hr_bron"></a>
                                    <span x-show="!viewingCompany.company_master_data?.email_hr_bron" class="text-sm text-gray-400">-</span>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Email Algemeen</label>
                                    <a x-show="viewingCompany.company_master_data?.email_algemeen" :href="'mailto:' + viewingCompany.company_master_data?.email_algemeen" class="text-sm text-blue-600 hover:underline" x-text="viewingCompany.company_master_data?.email_algemeen"></a>
                                    <span x-show="!viewingCompany.company_master_data?.email_algemeen" class="text-sm text-gray-400">-</span>
                                </div>
                            </div>
                            
                            <!-- Company Descriptions (Multilingual) -->
                            <div class="mt-4 space-y-3">
                                <div x-show="viewingCompany.company_master_data?.bedrijfsomschrijving_nl">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">🇳🇱 Bedrijfsomschrijving (NL)</label>
                                    <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="viewingCompany.company_master_data?.bedrijfsomschrijving_nl || '-'"></p>
                                </div>
                                <div x-show="viewingCompany.company_master_data?.bedrijfsomschrijving_fr">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">🇫🇷 Description de l'entreprise (FR)</label>
                                    <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="viewingCompany.company_master_data?.bedrijfsomschrijving_fr || '-'"></p>
                                </div>
                                <div x-show="viewingCompany.company_master_data?.bedrijfsomschrijving_en">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">🇬🇧 Company Description (EN)</label>
                                    <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="viewingCompany.company_master_data?.bedrijfsomschrijving_en || '-'"></p>
                                </div>
                            </div>
                            
                            <!-- Additional Info -->
                            <div class="mt-4 grid grid-cols-2 gap-4">
                                <div x-show="viewingCompany.company_master_data?.sector_en">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Sector</label>
                                    <p class="text-sm text-gray-900" x-text="viewingCompany.company_master_data?.sector_en || '-'"></p>
                                </div>
                                <div x-show="viewingCompany.company_master_data?.aantal_werknemers">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Aantal Werknemers</label>
                                    <p class="text-sm text-gray-900" x-text="viewingCompany.company_master_data?.aantal_werknemers || '-'"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Company Info -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-gray-900 mb-3">Company Information</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">LinkedIn Company ID</label>
                                    <p class="text-sm text-gray-900" x-text="viewingCompany.linkedin_company_id || '-'"></p>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Industry</label>
                                    <p class="text-sm text-gray-900" x-text="viewingCompany.industry || '-'"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex justify-between items-center pt-4 border-t">
                            <a :href="`/jobs?company_id=${viewingCompany.id}`" 
                               class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50">
                                <i data-lucide="briefcase" class="w-4 h-4 mr-2"></i>
                                View Jobs
                            </a>
                            <div class="flex space-x-3">
                                <button @click="showViewModal = false" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Close</button>
                                <button @click="editCompany(viewingCompany); showViewModal = false" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Edit Company</button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function companiesPage() {
    return {
        companies: [],
        loading: true,
        search: '',
        total: 0,
        withMasterData: 0,
        verified: 0,
        showModal: false,
        showViewModal: false,
        editingCompany: null,
        viewingCompany: null,
        formData: {},
        currentPage: 1,
        pageSize: 100,
        totalPages: 1,
        companiesCache: {},
        cacheTimestamp: {},
        cacheDuration: 10 * 60 * 1000, // 10 minutes
        selectedCompanies: [],
        enriching: false,
        aiStats: {
            total: 0,
            enriched: 0,
            unenriched: 0,
            percentage_enriched: 0
        },
        
        async init() {
            // Clear cache if schema version changed
            this.checkAndClearCache();
            this.loadCacheFromStorage();
            await this.loadCompanies();
            await this.loadAIStats();
            this.prefetchPages();
            this.$nextTick(() => lucide.createIcons());
        },
        
        checkAndClearCache() {
            const SCHEMA_VERSION = '3'; // Increment this when schema changes
            const currentVersion = localStorage.getItem('companiesSchemaVersion');
            
            if (currentVersion !== SCHEMA_VERSION) {
                console.log('Schema version changed, clearing cache...');
                localStorage.removeItem('companiesCache');
                localStorage.removeItem('companiesCacheTimestamp');
                localStorage.setItem('companiesSchemaVersion', SCHEMA_VERSION);
                this.companiesCache = {};
                this.cacheTimestamp = {};
            }
        },
        
        loadCacheFromStorage() {
            try {
                const cachedData = localStorage.getItem('companiesCache');
                const cachedTimestamps = localStorage.getItem('companiesCacheTimestamp');
                
                if (cachedData && cachedTimestamps) {
                    this.companiesCache = JSON.parse(cachedData);
                    this.cacheTimestamp = JSON.parse(cachedTimestamps);
                    
                    // Clean up expired cache entries
                    const now = Date.now();
                    Object.keys(this.cacheTimestamp).forEach(key => {
                        if (now - this.cacheTimestamp[key] > this.cacheDuration) {
                            delete this.companiesCache[key];
                            delete this.cacheTimestamp[key];
                        }
                    });
                    
                    console.log('Loaded companies cache from localStorage:', Object.keys(this.companiesCache).length, 'pages');
                }
            } catch (error) {
                console.error('Failed to load cache from storage:', error);
            }
        },
        
        saveCacheToStorage() {
            try {
                localStorage.setItem('companiesCache', JSON.stringify(this.companiesCache));
                localStorage.setItem('companiesCacheTimestamp', JSON.stringify(this.cacheTimestamp));
            } catch (error) {
                console.error('Failed to save cache to storage:', error);
            }
        },
        
        async prefetchPages() {
            for (let page = 2; page <= 3; page++) {
                setTimeout(() => {
                    this.fetchAndCachePage(page);
                }, (page - 1) * 500);
            }
        },
        
        async fetchAndCachePage(page) {
            const cacheKey = this.getCacheKey(page);
            
            try {
                const params = new URLSearchParams();
                if (this.search) params.append('search', this.search);
                params.append('limit', this.pageSize);
                params.append('offset', (page - 1) * this.pageSize);
                
                const response = await fetch(`/api/companies?${params}`);
                const data = await response.json();
                
                this.companiesCache[cacheKey] = data;
                this.cacheTimestamp[cacheKey] = Date.now();
                this.saveCacheToStorage();
                
                console.log(`Cached companies page ${page}`);
            } catch (error) {
                console.error(`Failed to prefetch companies page ${page}:`, error);
            }
        },
        
        getCacheKey(page) {
            return `${page}_${this.search}`;
        },
        
        isCacheValid(cacheKey) {
            if (!this.companiesCache[cacheKey]) return false;
            const age = Date.now() - (this.cacheTimestamp[cacheKey] || 0);
            return age < this.cacheDuration;
        },
        
        invalidateCache() {
            this.companiesCache = {};
            this.cacheTimestamp = {};
            localStorage.removeItem('companiesCache');
            localStorage.removeItem('companiesCacheTimestamp');
        },
        
        async loadCompanies() {
            this.loading = true;
            try {
                const cacheKey = this.getCacheKey(this.currentPage);
                
                // Check cache first
                if (this.isCacheValid(cacheKey)) {
                    console.log(`Loading companies page ${this.currentPage} from cache`);
                    const data = this.companiesCache[cacheKey];
                    this.companies = data.companies || [];
                    this.total = data.total || 0;
                    this.totalPages = Math.ceil(this.total / this.pageSize);
                    this.withMasterData = this.companies.filter(c => c.company_master_data).length;
                    this.verified = this.companies.filter(c => c.company_master_data?.verified).length;
                    this.loading = false;
                    this.$nextTick(() => lucide.createIcons());
                    return;
                }
                
                // Fetch from API
                console.log(`Fetching companies page ${this.currentPage} from API`);
                const params = new URLSearchParams();
                if (this.search) params.append('search', this.search);
                params.append('limit', this.pageSize);
                params.append('offset', (this.currentPage - 1) * this.pageSize);
                
                const response = await fetch(`/api/companies?${params}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                // Cache the data
                this.companiesCache[cacheKey] = data;
                this.cacheTimestamp[cacheKey] = Date.now();
                this.saveCacheToStorage();
                
                this.companies = data.companies || [];
                this.total = data.total || 0;
                this.totalPages = Math.ceil(this.total / this.pageSize);
                
                // Calculate stats
                this.withMasterData = this.companies.filter(c => c.company_master_data).length;
                this.verified = this.companies.filter(c => c.company_master_data?.verified).length;
                
                // Prefetch next page if on page 1 or 2
                if (this.currentPage <= 2) {
                    setTimeout(() => {
                        this.fetchAndCachePage(this.currentPage + 1);
                    }, 500);
                }
                
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to load companies:', error);
                this.companies = [];
                this.total = 0;
                alert('Failed to load companies: ' + error.message);
            } finally {
                this.loading = false;
            }
        },
        
        async nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                await this.loadCompanies();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        },
        
        async previousPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                await this.loadCompanies();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        },
        
        formatRevenue(masterData) {
            if (!masterData) return '-';
            if (masterData.revenue_range) return masterData.revenue_range;
            if (masterData.revenue_eur) {
                const revenue = masterData.revenue_eur;
                if (revenue >= 1000000) {
                    return '€' + (revenue / 1000000).toFixed(1) + 'M';
                } else if (revenue >= 1000) {
                    return '€' + (revenue / 1000).toFixed(0) + 'K';
                }
                return '€' + revenue;
            }
            return '-';
        },
        
        viewCompany(company) {
            this.viewingCompany = company;
            this.showViewModal = true;
            this.$nextTick(() => lucide.createIcons());
        },
        
        editCompany(company) {
            this.editingCompany = company;
            this.formData = {
                // AI Enriched fields only
                bedrijfswebsite: company.company_master_data?.bedrijfswebsite || '',
                jobspagina: company.company_master_data?.jobspagina || '',
                email_hr: company.company_master_data?.email_hr || '',
                email_hr_bron: company.company_master_data?.email_hr_bron || '',
                email_algemeen: company.company_master_data?.email_algemeen || ''
            };
            this.showModal = true;
            this.$nextTick(() => lucide.createIcons());
        },
        
        async saveMasterData() {
            try {
                const companyId = this.editingCompany.id;
                const masterData = this.editingCompany.company_master_data;
                const hasMasterData = masterData && (Array.isArray(masterData) ? masterData.length > 0 : true);
                
                // Clean the data: remove empty strings and convert string numbers to integers
                const cleanedData = {};
                for (const [key, value] of Object.entries(this.formData)) {
                    // Skip empty/null/undefined
                    if (value === '' || value === null || value === undefined) {
                        continue;
                    }
                    // Convert string numbers to integers for numeric fields
                    if ((key === 'employee_count' || key === 'revenue_eur') && typeof value === 'string') {
                        const numValue = parseInt(value, 10);
                        if (!isNaN(numValue)) {
                            cleanedData[key] = numValue;
                        }
                    } else {
                        cleanedData[key] = value;
                    }
                }
                
                console.log('Cleaned data to send:', cleanedData);
                
                const url = `/api/companies/${companyId}/master-data`;
                const method = hasMasterData ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cleanedData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    console.error('API Error:', response.status, errorData);
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                this.showModal = false;
                await this.loadCompanies();
                alert('Master data saved successfully!');
            } catch (error) {
                console.error('Failed to save:', error);
                alert('Failed to save master data: ' + error.message);
            }
        },
        
        
        async loadAIStats() {
            try {
                const response = await fetch('/api/companies/enrich/stats');
                this.aiStats = await response.json();
            } catch (error) {
                console.error('Failed to load AI stats:', error);
            }
        },
        
        toggleCompanySelection(companyId) {
            const index = this.selectedCompanies.indexOf(companyId);
            if (index > -1) {
                this.selectedCompanies.splice(index, 1);
            } else {
                this.selectedCompanies.push(companyId);
            }
        },
        
        toggleAll() {
            if (this.selectedCompanies.length === this.companies.length) {
                this.selectedCompanies = [];
            } else {
                this.selectedCompanies = this.companies.map(c => c.id);
            }
        },
        
        async enrichSelected() {
            if (this.selectedCompanies.length === 0) {
                alert('No companies selected');
                return;
            }
            
            if (!confirm(`Enrich ${this.selectedCompanies.length} selected company(ies)? This may take a few minutes.`)) {
                return;
            }
            
            this.enriching = true;
            
            try {
                const response = await fetch('/api/companies/enrich/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.selectedCompanies)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Enrichment failed');
                }
                
                const result = await response.json();
                
                if (result.stats) {
                    alert(`Enrichment complete!\nSuccessful: ${result.stats.successful}\nFailed: ${result.stats.failed}`);
                } else {
                    alert('Enrichment completed!');
                }
                
                // Clear selection
                this.selectedCompanies = [];
                
                // Clear cache to force fresh data
                this.companiesCache = {};
                this.cacheTimestamp = {};
                localStorage.removeItem('companiesCache');
                localStorage.removeItem('companiesCacheTimestamp');
                
                // Reload data
                await this.loadCompanies();
                await this.loadAIStats();
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to enrich companies:', error);
                alert('Failed to enrich companies: ' + error.message);
            } finally {
                this.enriching = false;
            }
        },
        
        async enrichAllUnenriched() {
            if (!confirm(`Enrich all ${this.aiStats.unenriched} unenriched companies? This may take several minutes.`)) {
                return;
            }
            
            this.enriching = true;
            
            try {
                // Get unenriched company IDs
                const response = await fetch('/api/companies/enrich/unenriched?limit=1000');
                const data = await response.json();
                
                if (data.company_ids.length === 0) {
                    alert('No unenriched companies found');
                    return;
                }
                
                // Enrich in batch
                const enrichResponse = await fetch('/api/companies/enrich/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data.company_ids)
                });
                
                if (!enrichResponse.ok) {
                    const error = await enrichResponse.json();
                    throw new Error(error.detail || 'Enrichment failed');
                }
                
                const result = await enrichResponse.json();
                
                if (result.stats) {
                    alert(`Enrichment complete!\nSuccessful: ${result.stats.successful}\nFailed: ${result.stats.failed}`);
                } else {
                    alert('Enrichment completed!');
                }
                
                // Clear cache to force fresh data
                this.companiesCache = {};
                this.cacheTimestamp = {};
                localStorage.removeItem('companiesCache');
                localStorage.removeItem('companiesCacheTimestamp');
                
                await this.loadCompanies();
                await this.loadAIStats();
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to enrich companies:', error);
                alert('Failed to enrich companies: ' + error.message);
            } finally {
                this.enriching = false;
            }
        }
    }
}
</script>
{% endblock %}
