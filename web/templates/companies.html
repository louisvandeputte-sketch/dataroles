{% extends "base.html" %}

{% block title %}Companies - DataRoles Admin{% endblock %}

{% block content %}
<div x-data="companiesPage()">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Companies</h1>
                <p class="text-gray-600 mt-1">Manage company master data</p>
            </div>
            <div class="flex items-center space-x-3">
                <!-- AI Enrichment Stats -->
                <div class="bg-purple-50 border border-purple-200 rounded-lg px-4 py-2">
                    <div class="text-sm text-purple-900">
                        <span class="font-semibold">AI Enriched:</span>
                        <span x-text="aiStats.enriched"></span> / <span x-text="aiStats.total"></span>
                        (<span x-text="aiStats.percentage_enriched"></span>%)
                    </div>
                </div>
                <!-- Enrich Selected Button -->
                <button @click="enrichSelected" 
                        :disabled="enriching || selectedCompanies.length === 0"
                        x-show="selectedCompanies.length > 0"
                        class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                    <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i>
                    <span x-show="!enriching">Enrich Selected (<span x-text="selectedCompanies.length"></span>)</span>
                    <span x-show="enriching">Enriching...</span>
                </button>
                <!-- Enrich All Button -->
                <button @click="enrichAllUnenriched" 
                        :disabled="enriching || aiStats.unenriched === 0"
                        class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                    <i data-lucide="zap" class="w-4 h-4 mr-2"></i>
                    <span x-show="!enriching">Enrich All (<span x-text="aiStats.unenriched"></span>)</span>
                    <span x-show="enriching">Enriching...</span>
                </button>
                <button @click="showImportModal = true" 
                        class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                    <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                    Import CSV
                </button>
                <button @click="exportToCSV" 
                        class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                    Export to CSV
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Total Companies</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="total"></p>
                    </div>
                    <i data-lucide="building-2" class="w-8 h-8 text-blue-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">With Master Data</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="withMasterData"></p>
                    </div>
                    <i data-lucide="database" class="w-8 h-8 text-green-500"></i>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Verified</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="verified"></p>
                    </div>
                    <i data-lucide="check-circle" class="w-8 h-8 text-purple-500"></i>
                </div>
            </div>
        </div>

        <!-- Search -->
        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <input type="text" x-model="search" @input="invalidateCache(); loadCompanies()" 
                   placeholder="Search companies..."
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
    </div>

    <!-- Companies Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div x-show="loading" class="text-center py-12">
            <i data-lucide="loader" class="w-8 h-8 mx-auto animate-spin text-blue-500 mb-3"></i>
            <p class="text-gray-500">Loading companies...</p>
        </div>

        <div x-show="!loading && companies.length === 0" class="text-center py-12">
            <i data-lucide="building-2" class="w-12 h-12 mx-auto text-gray-300 mb-3"></i>
            <p class="text-gray-500">No companies found</p>
        </div>

        <div x-show="!loading && companies.length > 0">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left">
                                <input type="checkbox" @change="toggleAll" class="rounded border-gray-300">
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Industry</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">KBO/VAT</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employees</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Growth</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">URL</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="company in companies" :key="company.id">
                        <tr class="hover:bg-gray-50">
                            <!-- Checkbox -->
                            <td class="px-4 py-3">
                                <input type="checkbox" 
                                       :checked="selectedCompanies.includes(company.id)"
                                       @change="toggleCompanySelection(company.id)"
                                       class="rounded border-gray-300">
                            </td>
                            <!-- Company Name & Logo -->
                            <td class="px-4 py-3">
                                <div class="flex items-center min-w-[200px]">
                                    <img x-show="company.logo_url" :src="company.logo_url" :alt="company.name" 
                                         class="w-8 h-8 rounded object-cover mr-2 flex-shrink-0">
                                    <div x-show="!company.logo_url" class="w-8 h-8 rounded bg-gray-200 flex items-center justify-center mr-2 flex-shrink-0">
                                        <i data-lucide="building-2" class="w-4 h-4 text-gray-400"></i>
                                    </div>
                                    <div class="text-sm font-medium text-gray-900 truncate" x-text="company.name"></div>
                                </div>
                            </td>
                            <!-- Industry (from LinkedIn) -->
                            <td class="px-4 py-3">
                                <span class="text-sm text-gray-900" x-text="company.industry || company.company_master_data?.industry || '-'"></span>
                            </td>
                            <!-- KBO/VAT Number -->
                            <td class="px-4 py-3">
                                <span class="text-sm text-gray-900" x-text="company.company_master_data?.company_number || '-'"></span>
                            </td>
                            <!-- Description -->
                            <td class="px-4 py-3">
                                <div class="text-sm text-gray-600 max-w-xs truncate" 
                                     :title="company.company_master_data?.description"
                                     x-text="company.company_master_data?.description || '-'"></div>
                            </td>
                            <!-- Employees -->
                            <td class="px-4 py-3">
                                <span class="text-sm text-gray-900" 
                                      x-text="company.company_master_data?.employee_count || company.company_master_data?.employee_count_range || '-'"></span>
                            </td>
                            <!-- Revenue -->
                            <td class="px-4 py-3">
                                <span class="text-sm text-gray-900" 
                                      x-text="formatRevenue(company.company_master_data)"></span>
                            </td>
                            <!-- Growth Trend -->
                            <td class="px-4 py-3">
                                <span x-show="company.company_master_data?.growth_trend" 
                                      class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                                      :class="{
                                          'bg-green-100 text-green-800': company.company_master_data?.growth_trend === 'Growing',
                                          'bg-blue-100 text-blue-800': company.company_master_data?.growth_trend === 'Stable',
                                          'bg-red-100 text-red-800': company.company_master_data?.growth_trend === 'Declining'
                                      }"
                                      x-text="company.company_master_data?.growth_trend"></span>
                                <span x-show="!company.company_master_data?.growth_trend" class="text-sm text-gray-400">-</span>
                            </td>
                            <!-- Jobs Page URL -->
                            <td class="px-4 py-3 text-center">
                                <a x-show="company.company_master_data?.jobs_page_url" 
                                   :href="company.company_master_data?.jobs_page_url" 
                                   target="_blank"
                                   class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200"
                                   title="Jobs Page URL">
                                    <i data-lucide="external-link" class="w-4 h-4"></i>
                                </a>
                                <span x-show="!company.company_master_data?.jobs_page_url" class="text-gray-300">
                                    <i data-lucide="external-link" class="w-4 h-4"></i>
                                </span>
                            </td>
                            <!-- Contact Email -->
                            <td class="px-4 py-3 text-center">
                                <a x-show="company.company_master_data?.contact_email" 
                                   :href="'mailto:' + company.company_master_data?.contact_email" 
                                   class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100 text-green-600 hover:bg-green-200"
                                   :title="company.company_master_data?.contact_email">
                                    <i data-lucide="mail" class="w-4 h-4"></i>
                                </a>
                                <span x-show="!company.company_master_data?.contact_email" class="text-gray-300">
                                    <i data-lucide="mail" class="w-4 h-4"></i>
                                </span>
                            </td>
                            <!-- Actions -->
                            <td class="px-4 py-3 text-right">
                                <div class="flex items-center justify-end space-x-1">
                                    <button @click="editCompany(company)" 
                                            class="inline-flex items-center px-2 py-1 border border-gray-300 rounded text-xs font-medium text-gray-700 bg-white hover:bg-gray-50">
                                        <i data-lucide="edit" class="w-3 h-3 mr-1"></i>
                                        Edit
                                    </button>
                                    <a :href="`/jobs?company_id=${company.id}`" 
                                       class="inline-flex items-center px-2 py-1 border border-gray-300 rounded text-xs font-medium text-gray-700 bg-white hover:bg-gray-50">
                                        <i data-lucide="briefcase" class="w-3 h-3 mr-1"></i>
                                        Jobs
                                    </a>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
                <div class="text-sm text-gray-700">
                    Showing <span class="font-medium" x-text="companies.length > 0 ? ((currentPage - 1) * pageSize) + 1 : 0"></span> to 
                    <span class="font-medium" x-text="Math.min(currentPage * pageSize, total)"></span> of 
                    <span class="font-medium" x-text="total"></span> companies
                </div>
                <div class="flex items-center space-x-2">
                    <button @click="previousPage" :disabled="currentPage === 1"
                            class="px-3 py-1 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Previous
                    </button>
                    <span class="text-sm text-gray-700">Page <span class="font-medium" x-text="currentPage"></span> of <span class="font-medium" x-text="totalPages"></span></span>
                    <button @click="nextPage" :disabled="currentPage >= totalPages"
                            class="px-3 py-1 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                        Next
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div x-show="showImportModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="showImportModal = false"></div>
            
            <div class="relative bg-white rounded-lg max-w-2xl w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Import Company Master Data</h3>
                    <button @click="showImportModal = false" class="text-gray-400 hover:text-gray-500">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-start">
                            <i data-lucide="info" class="w-5 h-5 text-blue-600 mr-2 mt-0.5 flex-shrink-0"></i>
                            <div class="text-sm text-blue-800">
                                <p class="font-medium mb-1">Import Instructions:</p>
                                <ul class="list-disc list-inside space-y-1">
                                    <li>Upload a CSV file with the same format as the export</li>
                                    <li><strong>First column MUST be LinkedIn Company ID</strong> - this is used to match companies</li>
                                    <li>Existing master data will be <strong>updated</strong>, new data will be <strong>created</strong></li>
                                    <li>Companies not found in the database will be skipped</li>
                                    <li>Empty rows and rows without LinkedIn Company ID are automatically skipped</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select CSV File</label>
                        <input type="file" 
                               @change="handleFileSelect" 
                               accept=".csv"
                               class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
                    </div>

                    <div x-show="importFile" class="bg-gray-50 rounded-lg p-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="file-text" class="w-5 h-5 text-gray-500 mr-2"></i>
                                <span class="text-sm text-gray-700" x-text="importFile?.name"></span>
                            </div>
                            <button @click="importFile = null" class="text-red-600 hover:text-red-700">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <div x-show="importResult" class="border rounded-lg p-4" :class="{
                        'bg-green-50 border-green-200': importResult?.success,
                        'bg-red-50 border-red-200': importResult && !importResult.success
                    }">
                        <div class="flex items-start">
                            <i :data-lucide="importResult?.success ? 'check-circle' : 'alert-circle'" 
                               class="w-5 h-5 mr-2 mt-0.5" 
                               :class="importResult?.success ? 'text-green-600' : 'text-red-600'"></i>
                            <div class="flex-1">
                                <p class="font-medium" :class="importResult?.success ? 'text-green-800' : 'text-red-800'" 
                                   x-text="importResult?.message"></p>
                                <div x-show="importResult?.stats" class="mt-2 text-sm" 
                                     :class="importResult?.success ? 'text-green-700' : 'text-red-700'">
                                    <p>Total rows: <span class="font-semibold" x-text="importResult?.stats?.total_rows"></span></p>
                                    <p>Skipped rows: <span class="font-semibold" x-text="importResult?.stats?.skipped_rows || 0"></span></p>
                                    <p>Companies found: <span class="font-semibold" x-text="importResult?.stats?.companies_found"></span></p>
                                    <p>Companies not found: <span class="font-semibold" x-text="importResult?.stats?.companies_not_found"></span></p>
                                    <p>Master data created: <span class="font-semibold text-green-700" x-text="importResult?.stats?.master_data_created"></span></p>
                                    <p>Master data updated: <span class="font-semibold text-blue-700" x-text="importResult?.stats?.master_data_updated"></span></p>
                                    <div x-show="importResult?.stats?.errors?.length > 0" class="mt-2">
                                        <p class="font-medium">Errors:</p>
                                        <ul class="list-disc list-inside">
                                            <template x-for="error in importResult.stats.errors.slice(0, 5)" :key="error.row">
                                                <li x-text="`Row ${error.row} - ${error.company_name || error.company || 'Unknown'} (ID: ${error.linkedin_id}): ${error.error}`"></li>
                                            </template>
                                            <li x-show="importResult.stats.errors.length > 5" 
                                                x-text="`... and ${importResult.stats.errors.length - 5} more errors`"></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button @click="showImportModal = false" 
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Close
                    </button>
                    <button @click="importCSV" 
                            :disabled="!importFile || importing"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span x-show="!importing">Import</span>
                        <span x-show="importing" class="flex items-center">
                            <i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i>
                            Importing...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple Edit Modal -->
    <div x-show="showModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="showModal = false"></div>
            
            <div class="relative bg-white rounded-lg max-w-2xl w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900" x-text="editingCompany?.name"></h3>
                    <button @click="showModal = false" class="text-gray-400 hover:text-gray-500">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Company Number (KBO/VAT)</label>
                        <input type="text" x-model="formData.company_number" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                               placeholder="e.g., BE0123456789">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea x-model="formData.description" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Industry</label>
                            <input type="text" x-model="formData.industry" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Employee Count</label>
                            <input type="number" x-model="formData.employee_count" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Revenue (EUR)</label>
                            <input type="number" x-model="formData.revenue_eur" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Growth Trend</label>
                            <select x-model="formData.growth_trend" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="">Select...</option>
                                <option value="Growing">Growing</option>
                                <option value="Stable">Stable</option>
                                <option value="Declining">Declining</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jobs Page URL</label>
                            <input type="url" x-model="formData.jobs_page_url" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                   placeholder="https://company.com/careers">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contact Email</label>
                            <input type="email" x-model="formData.contact_email" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                   placeholder="hr@company.com">
                        </div>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" x-model="formData.verified" id="verified" class="mr-2">
                        <label for="verified" class="text-sm text-gray-700">Mark as verified</label>
                    </div>
                </div>

                <div class="mt-6 flex justify-end space-x-3">
                    <button @click="showModal = false" 
                            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button @click="saveMasterData" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function companiesPage() {
    return {
        companies: [],
        loading: true,
        search: '',
        total: 0,
        withMasterData: 0,
        verified: 0,
        showModal: false,
        showImportModal: false,
        editingCompany: null,
        formData: {},
        currentPage: 1,
        pageSize: 100,
        totalPages: 1,
        importFile: null,
        importing: false,
        importResult: null,
        companiesCache: {},
        cacheTimestamp: {},
        cacheDuration: 10 * 60 * 1000, // 10 minutes
        selectedCompanies: [],
        enriching: false,
        aiStats: {
            total: 0,
            enriched: 0,
            unenriched: 0,
            percentage_enriched: 0
        },
        
        async init() {
            this.loadCacheFromStorage();
            await this.loadCompanies();
            await this.loadAIStats();
            this.prefetchPages();
            this.$nextTick(() => lucide.createIcons());
        },
        
        loadCacheFromStorage() {
            try {
                const cachedData = localStorage.getItem('companiesCache');
                const cachedTimestamps = localStorage.getItem('companiesCacheTimestamp');
                
                if (cachedData && cachedTimestamps) {
                    this.companiesCache = JSON.parse(cachedData);
                    this.cacheTimestamp = JSON.parse(cachedTimestamps);
                    
                    // Clean up expired cache entries
                    const now = Date.now();
                    Object.keys(this.cacheTimestamp).forEach(key => {
                        if (now - this.cacheTimestamp[key] > this.cacheDuration) {
                            delete this.companiesCache[key];
                            delete this.cacheTimestamp[key];
                        }
                    });
                    
                    console.log('Loaded companies cache from localStorage:', Object.keys(this.companiesCache).length, 'pages');
                }
            } catch (error) {
                console.error('Failed to load cache from storage:', error);
            }
        },
        
        saveCacheToStorage() {
            try {
                localStorage.setItem('companiesCache', JSON.stringify(this.companiesCache));
                localStorage.setItem('companiesCacheTimestamp', JSON.stringify(this.cacheTimestamp));
            } catch (error) {
                console.error('Failed to save cache to storage:', error);
            }
        },
        
        async prefetchPages() {
            for (let page = 2; page <= 3; page++) {
                setTimeout(() => {
                    this.fetchAndCachePage(page);
                }, (page - 1) * 500);
            }
        },
        
        async fetchAndCachePage(page) {
            const cacheKey = this.getCacheKey(page);
            
            try {
                const params = new URLSearchParams();
                if (this.search) params.append('search', this.search);
                params.append('limit', this.pageSize);
                params.append('offset', (page - 1) * this.pageSize);
                
                const response = await fetch(`/api/companies?${params}`);
                const data = await response.json();
                
                this.companiesCache[cacheKey] = data;
                this.cacheTimestamp[cacheKey] = Date.now();
                this.saveCacheToStorage();
                
                console.log(`Cached companies page ${page}`);
            } catch (error) {
                console.error(`Failed to prefetch companies page ${page}:`, error);
            }
        },
        
        getCacheKey(page) {
            return `${page}_${this.search}`;
        },
        
        isCacheValid(cacheKey) {
            if (!this.companiesCache[cacheKey]) return false;
            const age = Date.now() - (this.cacheTimestamp[cacheKey] || 0);
            return age < this.cacheDuration;
        },
        
        invalidateCache() {
            this.companiesCache = {};
            this.cacheTimestamp = {};
            localStorage.removeItem('companiesCache');
            localStorage.removeItem('companiesCacheTimestamp');
        },
        
        async loadCompanies() {
            this.loading = true;
            try {
                const cacheKey = this.getCacheKey(this.currentPage);
                
                // Check cache first
                if (this.isCacheValid(cacheKey)) {
                    console.log(`Loading companies page ${this.currentPage} from cache`);
                    const data = this.companiesCache[cacheKey];
                    this.companies = data.companies || [];
                    this.total = data.total || 0;
                    this.totalPages = Math.ceil(this.total / this.pageSize);
                    this.withMasterData = this.companies.filter(c => c.company_master_data).length;
                    this.verified = this.companies.filter(c => c.company_master_data?.verified).length;
                    this.loading = false;
                    this.$nextTick(() => lucide.createIcons());
                    return;
                }
                
                // Fetch from API
                console.log(`Fetching companies page ${this.currentPage} from API`);
                const params = new URLSearchParams();
                if (this.search) params.append('search', this.search);
                params.append('limit', this.pageSize);
                params.append('offset', (this.currentPage - 1) * this.pageSize);
                
                const response = await fetch(`/api/companies?${params}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                // Cache the data
                this.companiesCache[cacheKey] = data;
                this.cacheTimestamp[cacheKey] = Date.now();
                this.saveCacheToStorage();
                
                this.companies = data.companies || [];
                this.total = data.total || 0;
                this.totalPages = Math.ceil(this.total / this.pageSize);
                
                // Calculate stats
                this.withMasterData = this.companies.filter(c => c.company_master_data).length;
                this.verified = this.companies.filter(c => c.company_master_data?.verified).length;
                
                // Prefetch next page if on page 1 or 2
                if (this.currentPage <= 2) {
                    setTimeout(() => {
                        this.fetchAndCachePage(this.currentPage + 1);
                    }, 500);
                }
                
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to load companies:', error);
                this.companies = [];
                this.total = 0;
                alert('Failed to load companies: ' + error.message);
            } finally {
                this.loading = false;
            }
        },
        
        async nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                await this.loadCompanies();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        },
        
        async previousPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                await this.loadCompanies();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        },
        
        formatRevenue(masterData) {
            if (!masterData) return '-';
            if (masterData.revenue_range) return masterData.revenue_range;
            if (masterData.revenue_eur) {
                const revenue = masterData.revenue_eur;
                if (revenue >= 1000000) {
                    return '€' + (revenue / 1000000).toFixed(1) + 'M';
                } else if (revenue >= 1000) {
                    return '€' + (revenue / 1000).toFixed(0) + 'K';
                }
                return '€' + revenue;
            }
            return '-';
        },
        
        editCompany(company) {
            this.editingCompany = company;
            this.formData = {
                company_number: company.company_master_data?.company_number || '',
                description: company.company_master_data?.description || '',
                industry: company.company_master_data?.industry || '',
                employee_count: company.company_master_data?.employee_count || '',
                revenue_eur: company.company_master_data?.revenue_eur || '',
                growth_trend: company.company_master_data?.growth_trend || '',
                jobs_page_url: company.company_master_data?.jobs_page_url || '',
                contact_email: company.company_master_data?.contact_email || '',
                verified: company.company_master_data?.verified || false
            };
            this.showModal = true;
            this.$nextTick(() => lucide.createIcons());
        },
        
        async saveMasterData() {
            try {
                const companyId = this.editingCompany.id;
                const masterData = this.editingCompany.company_master_data;
                const hasMasterData = masterData && (Array.isArray(masterData) ? masterData.length > 0 : true);
                
                // Clean the data: remove empty strings and convert string numbers to integers
                const cleanedData = {};
                for (const [key, value] of Object.entries(this.formData)) {
                    // Skip empty/null/undefined
                    if (value === '' || value === null || value === undefined) {
                        continue;
                    }
                    // Convert string numbers to integers for numeric fields
                    if ((key === 'employee_count' || key === 'revenue_eur') && typeof value === 'string') {
                        const numValue = parseInt(value, 10);
                        if (!isNaN(numValue)) {
                            cleanedData[key] = numValue;
                        }
                    } else {
                        cleanedData[key] = value;
                    }
                }
                
                console.log('Cleaned data to send:', cleanedData);
                
                const url = `/api/companies/${companyId}/master-data`;
                const method = hasMasterData ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cleanedData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                    console.error('API Error:', response.status, errorData);
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                this.showModal = false;
                await this.loadCompanies();
                alert('Master data saved successfully!');
            } catch (error) {
                console.error('Failed to save:', error);
                alert('Failed to save master data: ' + error.message);
            }
        },
        
        async exportToCSV() {
            try {
                const params = new URLSearchParams();
                if (this.search) params.append('search', this.search);
                
                const response = await fetch(`/api/companies/export/csv?${params}`);
                
                if (!response.ok) {
                    throw new Error('Failed to export data');
                }
                
                // Get the blob from response
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `companies_export_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert('Export completed successfully!');
            } catch (error) {
                console.error('Failed to export:', error);
                alert('Failed to export data: ' + error.message);
            }
        },
        
        handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                this.importFile = file;
                this.importResult = null;
            }
        },
        
        async importCSV() {
            if (!this.importFile) return;
            
            this.importing = true;
            this.importResult = null;
            
            try {
                const formData = new FormData();
                formData.append('file', this.importFile);
                
                const response = await fetch('/api/companies/import/csv', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || 'Import failed');
                }
                
                this.importResult = result;
                this.importFile = null;
                
                // Reload companies after successful import
                if (result.success) {
                    await this.loadCompanies();
                }
                
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to import:', error);
                this.importResult = {
                    success: false,
                    message: 'Import failed: ' + error.message
                };
                this.$nextTick(() => lucide.createIcons());
            } finally {
                this.importing = false;
            }
        },
        
        async loadAIStats() {
            try {
                const response = await fetch('/api/companies/enrich/stats');
                this.aiStats = await response.json();
            } catch (error) {
                console.error('Failed to load AI stats:', error);
            }
        },
        
        toggleCompanySelection(companyId) {
            const index = this.selectedCompanies.indexOf(companyId);
            if (index > -1) {
                this.selectedCompanies.splice(index, 1);
            } else {
                this.selectedCompanies.push(companyId);
            }
        },
        
        toggleAll() {
            if (this.selectedCompanies.length === this.companies.length) {
                this.selectedCompanies = [];
            } else {
                this.selectedCompanies = this.companies.map(c => c.id);
            }
        },
        
        async enrichSelected() {
            if (this.selectedCompanies.length === 0) {
                alert('No companies selected');
                return;
            }
            
            if (!confirm(`Enrich ${this.selectedCompanies.length} selected company(ies)? This may take a few minutes.`)) {
                return;
            }
            
            this.enriching = true;
            
            try {
                const response = await fetch('/api/companies/enrich/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.selectedCompanies)
                });
                
                const result = await response.json();
                
                alert(`Enrichment complete!\nSuccessful: ${result.stats.successful}\nFailed: ${result.stats.failed}`);
                
                // Clear selection
                this.selectedCompanies = [];
                
                // Reload data
                await this.loadCompanies();
                await this.loadAIStats();
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to enrich companies:', error);
                alert('Failed to enrich companies: ' + error.message);
            } finally {
                this.enriching = false;
            }
        },
        
        async enrichAllUnenriched() {
            if (!confirm(`Enrich all ${this.aiStats.unenriched} unenriched companies? This may take several minutes.`)) {
                return;
            }
            
            this.enriching = true;
            
            try {
                // Get unenriched company IDs
                const response = await fetch('/api/companies/enrich/unenriched?limit=1000');
                const data = await response.json();
                
                if (data.company_ids.length === 0) {
                    alert('No unenriched companies found');
                    return;
                }
                
                // Enrich in batch
                const enrichResponse = await fetch('/api/companies/enrich/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data.company_ids)
                });
                
                const result = await enrichResponse.json();
                
                alert(`Enrichment complete!\nSuccessful: ${result.stats.successful}\nFailed: ${result.stats.failed}`);
                
                await this.loadCompanies();
                await this.loadAIStats();
                this.$nextTick(() => lucide.createIcons());
            } catch (error) {
                console.error('Failed to enrich companies:', error);
                alert('Failed to enrich companies: ' + error.message);
            } finally {
                this.enriching = false;
            }
        }
    }
}
</script>
{% endblock %}
